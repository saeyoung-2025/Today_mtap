<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê³„ë¶€ - Today App</title>
    <link rel="icon" type="image/png" href="icon-192.png">
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #FAFAFA;
            --bg-secondary: #FFFFFF;
            --bg-card: #FFFFFF;
            --text-primary: #1A1A1A;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --border-color: #E5E7EB;
            --accent: #3B82F6;
            --accent-light: #EFF6FF;
            --success: #10B981;
            --success-light: #D1FAE5;
            --danger: #EF4444;
            --danger-light: #FEE2E2;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --purple: #8B5CF6;
            --purple-light: #EDE9FE;
            --orange: #F97316;
            --orange-light: #FFEDD5;
            --cream: #FFF8E7;
            --cream-border: #F5DEB3;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: all 0.2s ease;
        }
        body.theme-gray {
            --bg-primary: #F3F4F6;
            --bg-secondary: #E5E7EB;
            --bg-card: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #4B5563;
            --text-muted: #9CA3AF;
            --border-color: #D1D5DB;
            --accent: #6366F1;
            --accent-light: #EEF2FF;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
            transition: var(--transition);
        }
        .container { max-width: 100%; }
        .page-header { text-align: center; margin-bottom: 16px; }
        .page-header h1 { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .page-header h1 i { color: var(--accent); margin-right: 8px; }
        .balance-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
        }
        .balance-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }
        .balance-value { font-size: 2rem; font-weight: 700; color: var(--text-primary); }
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }
        .nav-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        .nav-btn:hover:not(:disabled) { background: var(--accent); color: white; border-color: var(--accent); }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-indicator { font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); }
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }
        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-title i { color: var(--accent); }
        .page-content { display: none; }
        .page-content.active { display: block; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.9rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition);
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--accent); background: var(--bg-card); }
        .form-textarea { min-height: 80px; resize: vertical; }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-secondary { background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-secondary); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 8px 12px; font-size: 0.75rem; }
        .action-buttons { display: flex; gap: 12px; margin-top: 16px; }
        .action-buttons .btn { flex: 1; }
        .stats-summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px; }
        .stat-item { text-align: center; padding: 12px; background: var(--bg-primary); border-radius: var(--radius-md); }
        .stat-item .label { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 4px; }
        .stat-item .value { font-size: 0.9rem; font-weight: 600; }
        .stat-item .value.income { color: var(--success); }
        .stat-item .value.expense { color: var(--danger); }
        .stat-item .value.balance { color: var(--accent); }
        .chart-container { margin-top: 16px; }
        .ledger-month { margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: var(--radius-md); overflow: hidden; }
        .ledger-month-header { background: var(--accent); color: white; padding: 12px 16px; font-weight: 600; text-align: center; }
        .ledger-month-stats { display: flex; justify-content: space-around; padding: 12px; background: var(--bg-primary); border-bottom: 1px solid var(--border-color); font-size: 0.8rem; }
        .income-text { color: var(--success); }
        .expense-text { color: var(--danger); }
        .ledger-table { width: 100%; border-collapse: collapse; }
        .ledger-table th, .ledger-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.85rem; }
        .ledger-table th { background: var(--bg-primary); font-weight: 600; color: var(--text-secondary); }
        .ledger-table .saving-text { color: var(--purple); }
        .ledger-table .fixed-text { color: var(--warning); }
        .empty-state { text-align: center; color: var(--text-muted); padding: 40px 20px; }
        .empty-state i { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.5; display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .year-stat-box { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; }
        .year-stat-box .year { font-size: 1rem; font-weight: 700; margin-bottom: 12px; color: var(--text-primary); }
        .year-stat-box .stat-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 4px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-card); border-radius: var(--radius-lg); padding: 24px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 1.25rem; color: var(--text-muted); cursor: pointer; }
        .modal-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: var(--text-primary); }
        .backup-card { border-color: var(--accent); }
        .backup-card p { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.5; }
        .backup-btn-group { display: flex; flex-direction: column; gap: 8px; }
        .backup-btn-group .btn { width: 100%; }
        .danger-card { border-color: var(--danger); background: var(--danger-light); }
        .danger-card .card-title { color: var(--danger); }
        .danger-card p { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px; }
        
        /* Page 4 Fixed Items */
        .fixed-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: var(--bg-card); border-bottom: 1px solid var(--border-color); }
        .fixed-item:last-child { border-bottom: none; }
        .fixed-item .item-info { flex: 1; }
        .fixed-item .item-name { font-weight: 500; font-size: 0.85rem; color: var(--text-primary); }
        .fixed-item .item-note { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
        .fixed-item .item-amount { font-weight: 600; font-size: 0.85rem; margin-right: 8px; }
        .fixed-item .item-amount.income { color: var(--success); }
        .fixed-item .item-amount.saving { color: var(--purple); }
        .fixed-item .item-amount.fixed { color: var(--warning); }
        .fixed-item .item-amount.food { color: var(--orange); }
        .fixed-item .item-actions { display: flex; gap: 4px; }
        .fixed-item .item-actions button { padding: 4px 8px; font-size: 0.65rem; }
        .section-box { border: 1px solid var(--border-color); border-radius: var(--radius-md); overflow: hidden; margin-bottom: 16px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; color: white; position: relative; }
        .section-header.income-header { background: var(--success); }
        .section-header.saving-header { background: var(--purple); }
        .section-header.fixed-header { background: var(--warning); }
        .section-header.food-header { background: var(--orange); }
        .section-header h3 { font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .section-header .info-btn { background: rgba(255,255,255,0.3); border: none; color: white; width: 22px; height: 22px; border-radius: 50%; font-size: 0.7rem; cursor: pointer; margin-left: 8px; }
        .section-header .section-total { font-size: 0.9rem; font-weight: 700; }
        .section-items { background: var(--bg-primary); }
        .empty-section { padding: 20px; text-align: center; color: var(--text-muted); font-size: 0.8rem; }
        .summary-box { background: var(--cream); border: 2px solid var(--cream-border); border-radius: var(--radius-lg); padding: 20px; margin-top: 24px; }
        .summary-box .summary-title { font-size: 1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 16px; text-align: center; padding-bottom: 12px; border-bottom: 2px solid var(--cream-border); }
        .summary-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 0.85rem; }
        .summary-row.with-border { border-bottom: 1px solid var(--cream-border); padding-bottom: 12px; margin-bottom: 8px; }
        .summary-row .label { color: var(--text-secondary); }
        .summary-row .value { font-weight: 600; }
        .summary-row .value.positive { color: var(--success); }
        .summary-row .value.negative { color: var(--danger); }
        .summary-row.highlight { background: rgba(255, 255, 255, 0.7); margin: 12px -20px -20px -20px; padding: 16px 20px; border-radius: 0 0 var(--radius-lg) var(--radius-lg); font-weight: 700; font-size: 1rem; }
        .add-item-form { background: var(--bg-primary); border-radius: var(--radius-md); padding: 16px; margin-bottom: 20px; }
        .add-item-form .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        /* ìœ í˜•ë³„ í˜„í™© í‘œ */
        .type-summary-table { border: 1px solid var(--border-color); border-radius: var(--radius-md); overflow: hidden; }
        .type-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border-color); }
        .type-row:last-child { border-bottom: none; }
        .type-label { font-size: 0.85rem; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
        .type-label i { width: 16px; }
        .type-value { font-size: 0.9rem; font-weight: 600; }
        .income-row { background: var(--success-light); }
        .income-row .type-label i { color: var(--success); }
        .income-row .type-value { color: var(--success); }
        .expense-row .type-label i { color: var(--danger); }
        .expense-row .type-value { color: var(--danger); }
        .saving-row { background: var(--purple-light); }
        .saving-row .type-label i { color: var(--purple); }
        .saving-row .type-value { color: var(--purple); }
        .fixed-row { background: var(--warning-light); }
        .fixed-row .type-label i { color: var(--warning); }
        .fixed-row .type-value { color: var(--warning); }
        .total-row { background: var(--accent-light); }
        .total-row .type-label { font-weight: 600; color: var(--text-primary); }
        .total-row .type-label i { color: var(--accent); }
        .total-row .type-value { color: var(--accent); font-size: 1rem; }
        
        /* Info Popup */
        .info-popup { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .info-popup.active { display: flex; }
        .info-popup-content { background: white; border-radius: var(--radius-lg); padding: 20px; width: 85%; max-width: 350px; }
        .info-popup-content h4 { font-size: 1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .info-popup-content p { font-size: 0.85rem; line-height: 1.6; color: var(--text-secondary); white-space: pre-wrap; }
        .info-popup-content button { margin-top: 16px; width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header"><h1><i class="fas fa-wallet"></i>ê°€ê³„ë¶€</h1></div>
        <div class="balance-card">
            <div class="balance-label">ì˜¬í•´ ì´ ì”ì•¡</div>
            <div class="balance-value" id="currentBalance">0ì›</div>
        </div>
        <div class="nav-bar">
            <button id="prevPageBtn" class="nav-btn"><i class="fas fa-chevron-left"></i> ì´ì „</button>
            <span class="page-indicator" id="pageIndicator">1 / 5</span>
            <button id="nextPageBtn" class="nav-btn">ë‹¤ìŒ <i class="fas fa-chevron-right"></i></button>
        </div>

        <!-- Page 1: Record -->
        <div id="page1" class="page-content active">
            <div class="card">
                <div class="card-title"><i class="fas fa-plus-circle"></i>ìƒˆ ê±°ë˜ ê¸°ë¡</div>
                <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="budgetDate" class="form-input"></div>
                <div class="form-group"><label>ìœ í˜•</label>
                    <select id="budgetType" class="form-select">
                        <option value="income">ìˆ˜ì…</option>
                        <option value="expense">ì¼ë°˜ì§€ì¶œ (ì‹ë¹„ ë“±)</option>
                        <option value="saving">ì €ì¶•ì„±ì§€ì¶œ</option>
                        <option value="fixed">ë¹„ì €ì¶•ì„±ì§€ì¶œ</option>
                    </select>
                </div>
                <div class="form-group"><label>ê¸ˆì•¡ (ì›)</label><input type="number" id="budgetAmount" class="form-input" placeholder="ê¸ˆì•¡ ì…ë ¥" min="1"></div>
                <div class="form-group"><label>ì¹´í…Œê³ ë¦¬</label><select id="budgetCategory" class="form-select"></select></div>
                <div class="form-group"><label>ë©”ëª¨ (ì„ íƒ)</label><textarea id="budgetMemo" class="form-textarea" placeholder="ê°„ë‹¨í•œ ë©”ëª¨"></textarea></div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" id="clearInputBtn"><i class="fas fa-eraser"></i> ë¹„ìš°ê¸°</button>
                    <button class="btn btn-success" id="saveBudgetBtn"><i class="fas fa-save"></i> ì €ì¥</button>
                </div>
            </div>
            <div class="card">
                <div class="card-title"><i class="fas fa-chart-pie"></i>ì´ë²ˆ ë‹¬ í˜„í™©</div>
                <div class="stats-summary">
                    <div class="stat-item"><div class="label">ìˆ˜ì…</div><div class="value income" id="monthlyIncome">0ì›</div></div>
                    <div class="stat-item"><div class="label">ì§€ì¶œ</div><div class="value expense" id="monthlyExpense">0ì›</div></div>
                    <div class="stat-item"><div class="label">ì”ì•¡</div><div class="value balance" id="monthlyBalance">0ì›</div></div>
                </div>
                <div class="chart-container"><canvas id="dailyExpenseChart"></canvas></div>
            </div>
            
            <!-- ìœ í˜•ë³„ í˜„í™© í‘œ -->
            <div class="card">
                <div class="card-title"><i class="fas fa-list-ul"></i>ì´ë²ˆ ë‹¬ ìœ í˜•ë³„ í˜„í™©</div>
                <div class="type-summary-table">
                    <div class="type-row income-row">
                        <span class="type-label"><i class="fas fa-arrow-down"></i> ìˆ˜ì…</span>
                        <span class="type-value" id="typeIncome">+0ì›</span>
                    </div>
                    <div class="type-row expense-row">
                        <span class="type-label"><i class="fas fa-utensils"></i> ì¼ë°˜ì§€ì¶œ</span>
                        <span class="type-value" id="typeExpense">-0ì›</span>
                    </div>
                    <div class="type-row saving-row">
                        <span class="type-label"><i class="fas fa-piggy-bank"></i> ì €ì¶•ì„±ì§€ì¶œ</span>
                        <span class="type-value" id="typeSaving">-0ì›</span>
                    </div>
                    <div class="type-row fixed-row">
                        <span class="type-label"><i class="fas fa-file-invoice-dollar"></i> ë¹„ì €ì¶•ì„±ì§€ì¶œ</span>
                        <span class="type-value" id="typeFixed">-0ì›</span>
                    </div>
                    <div class="type-row total-row">
                        <span class="type-label"><i class="fas fa-coins"></i> ì”ì•¡</span>
                        <span class="type-value" id="typeTotal">0ì›</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 2: Ledger -->
        <div id="page2" class="page-content">
            <div class="card">
                <div class="card-title"><i class="fas fa-book"></i>ì›”ë³„ ì¥ë¶€</div>
                <div id="monthlyLedgersContent"><div class="empty-state"><i class="fas fa-receipt"></i><p>ê¸°ë¡ëœ ì¥ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤</p></div></div>
            </div>
        </div>

        <!-- Page 3: Stats + Backup -->
        <div id="page3" class="page-content">
            <div class="card">
                <div class="card-title"><i class="fas fa-bullseye"></i>ë‚˜ì˜ ëª©í‘œ</div>
                <div id="goalDisplayArea" style="display: none;">
                    <div id="goalDisplayText" style="background: var(--bg-primary); padding: 16px; border-radius: var(--radius-md); margin-bottom: 16px; line-height: 1.6; white-space: pre-wrap;"></div>
                    <div class="action-buttons">
                        <button id="editGoalBtn" class="btn btn-primary"><i class="fas fa-edit"></i> ìˆ˜ì •</button>
                        <button id="deleteGoalBtn" class="btn btn-danger"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                    </div>
                </div>
                <div id="goalEditArea">
                    <div class="form-group"><textarea id="goalMemoInput" class="form-textarea" placeholder="ì¥ê¸° ì¬ì • ëª©í‘œë¥¼ ì„¤ì •í•˜ì„¸ìš”..."></textarea></div>
                    <div class="action-buttons">
                        <button id="saveGoalBtn" class="btn btn-primary"><i class="fas fa-save"></i> ì €ì¥</button>
                        <button id="cancelGoalBtn" class="btn btn-secondary" style="display: none;"><i class="fas fa-times"></i> ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-title"><i class="fas fa-chart-line"></i>5ê°œë…„ í†µê³„</div>
                <div class="stats-grid" id="fiveYearStatsContent"><div class="empty-state"><i class="fas fa-chart-bar"></i><p>í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p></div></div>
            </div>
            
            <!-- ì´ì „ ë…„ë„ ë³´ê¸° -->
            <button class="btn btn-secondary" onclick="togglePastYears()" style="width: 100%; margin-bottom: 12px; background: white; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <i class="fas fa-history" id="pastYearsIcon"></i> 
                <span id="pastYearsText">ì´ì „ ë…„ë„ ë³´ê¸°</span>
            </button>
            <div id="pastYearsSection" style="display: none;">
                <div class="card">
                    <div class="card-title"><i class="fas fa-archive"></i>ì´ì „ ë…„ë„ ê¸°ë¡</div>
                    <div class="stats-grid" id="pastYearsContent"><div class="empty-state"><i class="fas fa-folder-open"></i><p>ì´ì „ ë…„ë„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p></div></div>
                </div>
            </div>
            
            <!-- ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ -->
            <button class="btn btn-secondary" onclick="toggleBackupSection()" style="width: 100%; margin-bottom: 12px; background: white; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <i class="fas fa-chevron-down" id="backupToggleIcon"></i> 
                <span id="backupToggleText">ë°±ì—…/ì´ˆê¸°í™” ì„¹ì…˜ í¼ì¹˜ê¸°</span>
            </button>
            
            <div id="backupSection" style="display: none;">
                <div class="card backup-card">
                    <div class="card-title"><i class="fas fa-cloud"></i>ë°ì´í„° ë°±ì—…/ë³µì›</div>
                    <p style="font-size: 0.85rem; line-height: 1.6;">ğŸ’¾ ëª¨ë“  ë°ì´í„°ëŠ” <strong>ì˜êµ¬ ì €ì¥</strong>ë©ë‹ˆë‹¤. í™”ë©´ì—ëŠ” ìµœê·¼ 5ë…„ë§Œ í‘œì‹œë˜ì§€ë§Œ, ì´ì „ ë…„ë„ëŠ” ìœ„ì˜ 'ì´ì „ ë…„ë„ ë³´ê¸°'ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">ìƒˆ ë””ë°”ì´ìŠ¤ ì‚¬ìš© ì‹œ ë°±ì—…/ë³µì›ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    
                    <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px; margin: 12px 0; font-size: 0.8rem; line-height: 1.6;">
                        <p>ğŸ’» <strong>PC</strong>: 'PC ë°±ì—…' í´ë¦­ â†’ í…ìŠ¤íŠ¸ë¥¼ ë©”ëª¨ì¥ì— ì €ì¥</p>
                        <p style="margin-top: 6px;">ğŸ“± <strong>ëª¨ë°”ì¼</strong>: 'ëª¨ë°”ì¼ ë°±ì—…' í´ë¦­ â†’ ì¹´í†¡ ë‚˜ì—ê²Œ ë³´ë‚´ê¸° ë˜ëŠ” ë©”ì¼ë¡œ ì „ì†¡</p>
                        <p style="margin-top: 6px;">ğŸ”„ <strong>ë³µì›</strong>: ì €ì¥í•œ íŒŒì¼(.json ë˜ëŠ” .txt)ì„ ì„ íƒí•˜ì—¬ ë³µì›</p>
                    </div>
                    
                    <div class="backup-btn-group">
                        <button class="btn btn-primary" onclick="displayDataAsJson()"><i class="fas fa-desktop"></i> PC ë°±ì—…</button>
                        <button class="btn btn-primary" onclick="mobileBackup()"><i class="fas fa-mobile-alt"></i> ëª¨ë°”ì¼ ë°±ì—…</button>
                        <input type="file" id="backupFileInput" accept=".json, .txt" style="display: none;" onchange="importDataFromJson(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('backupFileInput').click()"><i class="fas fa-upload"></i> ë°±ì—… íŒŒì¼ ë³µì›</button>
                    </div>
                </div>
                <div class="card danger-card">
                    <div class="card-title"><i class="fas fa-exclamation-triangle"></i>ìœ„í—˜ êµ¬ì—­</div>
                    <p>ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ëª¨ë“  ê°€ê³„ë¶€ ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.</p>
                    <button id="globalResetBtn" class="btn btn-danger" style="width: 100%;"><i class="fas fa-trash"></i> ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>

        <!-- Page 4: Fixed Income/Expense -->
        <div id="page4" class="page-content">
            <div class="card">
                <div class="card-title" style="justify-content: space-between;">
                    <span><i class="fas fa-clipboard-list"></i>ê³ ì • ìˆ˜ì…/ì§€ì¶œ ê´€ë¦¬</span>
                    <button class="btn btn-sm btn-secondary" onclick="showPageNotice()" style="padding: 6px 10px;"><i class="fas fa-bell"></i> ì•Œë¦¼</button>
                </div>
                <div class="add-item-form">
                    <div class="form-group"><label>ë¶„ë¥˜</label>
                        <select id="fixedType" class="form-select">
                            <option value="income">ê³ ì •ìˆ˜ì…</option>
                            <option value="food">í‰ê· ì›”ì‹ìì¬ë¹„</option>
                            <option value="saving">ì €ì¶•ì„±ì§€ì¶œ</option>
                            <option value="fixed">ì˜ë¬´ì§€ì¶œ(ë¹„ì €ì¶•ì„±)</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>í•­ëª©ëª…</label><input type="text" id="fixedName" class="form-input" placeholder="ì˜ˆ: ì›”ê¸‰, ì ê¸ˆ"></div>
                        <div class="form-group"><label>ê¸ˆì•¡ (ì›)</label><input type="number" id="fixedAmount" class="form-input" placeholder="ê¸ˆì•¡" min="1"></div>
                    </div>
                    <div class="form-group"><label>ë¹„ê³  (ì„ íƒ)</label><input type="text" id="fixedNote" class="form-input" placeholder="ê°„ë‹¨í•œ ë©”ëª¨"></div>
                    <button class="btn btn-success" id="addFixedBtn" style="width: 100%;"><i class="fas fa-plus"></i> í•­ëª© ì¶”ê°€</button>
                </div>
                <div id="fixedItemsList"></div>
                <div class="summary-box" id="fixedSummary" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div class="modal-title">ê±°ë˜ ìˆ˜ì •</div>
            <div id="modalBody"></div>
        </div>
    </div>
    <div id="fixedModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeFixedModal()">&times;</button>
            <div class="modal-title">í•­ëª© ìˆ˜ì •</div>
            <div id="fixedModalBody"></div>
        </div>
    </div>
    
    <!-- Info Popup -->
    <div id="infoPopup" class="info-popup">
        <div class="info-popup-content">
            <h4 id="infoPopupTitle">ğŸ’¡ í•´ë‹¹ í•­ëª© ì˜ˆì‹œ</h4>
            <p id="infoPopupText"></p>
            <button class="btn btn-primary" onclick="closeInfoPopup()">í™•ì¸</button>
        </div>
    </div>
    
    <!-- Page Notice Popup -->
    <div id="pageNoticePopup" class="info-popup">
        <div class="info-popup-content">
            <h4><i class="fas fa-bell"></i> ì•ˆë‚´</h4>
            <p style="line-height: 1.8;">ì´ í˜ì´ì§€ëŠ” ê°€ê³„ë¶€ ì„¸ë¶€ì‚¬í•­(ì•ì˜ í˜ì´ì§€ë“¤)ê³¼ëŠ” ì—°ë™(ë™ê¸°í™”)ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ë‚˜ì˜ ì›” ìˆ˜ì…ê³¼ ì§€ì¶œ ë‚´ì—­ì„ í•œëˆˆì— ì•Œì•„ë³´ê¸° ì‰½ê²Œ ì„¤ì •í•´ë³´ê³  íŒŒì•…í•˜ê¸° ìœ„í•œ ê²ƒì´ë¯€ë¡œ, ì–¸ì œë“  ë³€ê²½í•˜ê±°ë‚˜ ì¬ì„¤ì •í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ğŸ’¡ ì¬ë¬´ì„¤ê³„ íŒŒì•…ê³¼ ë¦¬ë‰´ì–¼í•´ì•¼í•  ë¶€ë¶„ì„ ë‹¤ë¥¸í˜ì´ì§€ì™€ ë‹¬ë¦¬ ë…ë¦½ì ìœ¼ë¡œ íŒŒì•…í•´ì„œ í™œìš©í•´ë³´ì„¸ìš”!</p>
            <button class="btn btn-primary" onclick="closePageNotice()">í™•ì¸</button>
        </div>
    </div>

    <script>
        window.addEventListener('message', (event) => {
            if (event.data.type === 'themeChange') {
                document.body.classList.remove('theme-gray');
                if (event.data.theme === 'gray') document.body.classList.add('theme-gray');
            }
        });
        const savedTheme = localStorage.getItem('today_app_theme');
        if (savedTheme === 'gray') document.body.classList.add('theme-gray');

        const db = new Dexie('BudgetAppDB');
        db.version(4).stores({
            budgets: '++id, date, type, amount, category',
            goals: 'id',
            fixedItems: '++id, type, name, amount, note'
        });

        let dailyExpenseChartInstance = null;
        let currentPage = 1;
        const totalPages = 4;
        let currentEditingId = null;
        let currentFixedEditingId = null;

        const tooltipDescriptions = {
            income: 'ğŸ’¡ í•´ë‹¹ í•­ëª© ì˜ˆì‹œ:\nì›”ê¸‰, ì •ê¸°ìš©ëˆ, ë¶€ìˆ˜ì…, ì„ëŒ€ìˆ˜ì…, ì—°ê¸ˆìˆ˜ë ¹, ì´ììˆ˜ì…, ë°°ë‹¹ê¸ˆ ë“±\n\në§¤ì›” ê³ ì •ì ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ìˆ˜ì…',
            food: 'ğŸ’¡ í•´ë‹¹ í•­ëª© ì˜ˆì‹œ:\nì‹ë£Œí’ˆë¹„, ë§ˆíŠ¸ì¥ë³´ê¸°, ë°˜ì°¬ê°’, ì •ìœ¡ì , ê³¼ì¼ê°€ê²Œ ë“±\n\në§¤ì›” ì˜ˆìƒë˜ëŠ” í‰ê·  ì‹ìì¬ ë¹„ìš©\n\nâ€» ì˜ˆì‚°ì„ ì •í•´ë‘ê³  ì ˆì•½í•˜ëŠ” ë¬˜ë¯¸!',
            saving: 'ğŸ’¡ í•´ë‹¹ í•­ëª© ì˜ˆì‹œ:\nì˜ˆê¸ˆ, ì ê¸ˆ, ì €ì¶•ë³´í—˜, ì—°ê¸ˆë³´í—˜, ì—°ê¸ˆì €ì¶•, í‡´ì§ì—°ê¸ˆ, í€ë“œ, ì£¼ì‹íˆ¬ì, ì²­ì•½ì €ì¶• ë“±\n\nìì‚°ì„ ë¶ˆë¦¬ëŠ” ì§€ì¶œ',
            fixed: 'ğŸ’¡ í•´ë‹¹ í•­ëª© ì˜ˆì‹œ:\në³´ì¥ì„±ë³´í—˜(ì‹¤ë¹„/ì•”ë³´í—˜ ë“±), ê³µê³¼ê¸ˆ(ì „ê¸°/ìˆ˜ë„/ê°€ìŠ¤), í†µì‹ ë¹„, ê´€ë¦¬ë¹„, ì›”ì„¸, ëŒ€ì¶œì´ì, êµí†µì •ê¸°ê¶Œ, êµ¬ë…ë£Œ(ë„·í”Œë¦­ìŠ¤ ë“±) ë“±\n\në§¤ì›” ì˜ë¬´ì ìœ¼ë¡œ ë‚˜ê°€ëŠ” ì§€ì¶œ'
        };

        const categories = {
            income: [
                { value: 'ì›”ê¸‰', label: 'ğŸ’µ ì›”ê¸‰' },
                { value: 'ìš©ëˆ', label: 'ğŸ’° ìš©ëˆ' },
                { value: 'ë¶€ìˆ˜ì…', label: 'âœ¨ ë¶€ìˆ˜ì…' },
                { value: 'ê¸°íƒ€_ìˆ˜ì…', label: 'ğŸ“¦ ê¸°íƒ€' }
            ],
            expense: [
                { value: 'ì‹ë¹„', label: 'ğŸ” ì‹ë¹„' },
                { value: 'êµí†µ', label: 'ğŸšŒ êµí†µ' },
                { value: 'ì‡¼í•‘', label: 'ğŸ›ï¸ ì‡¼í•‘' },
                { value: 'ìƒí™œ', label: 'ğŸ  ìƒí™œ' },
                { value: 'ê²½ì¡°ì‚¬', label: 'ğŸ ê²½ì¡°ì‚¬' },
                { value: 'ê¸°íƒ€_ì§€ì¶œ', label: 'ğŸ“¦ ê¸°íƒ€' }
            ],
            saving: [
                { value: 'ì˜ˆê¸ˆ', label: 'ğŸ¦ ì˜ˆê¸ˆ' },
                { value: 'ì ê¸ˆ', label: 'ğŸ’ ì ê¸ˆ' },
                { value: 'ì €ì¶•ë³´í—˜', label: 'ğŸ›¡ï¸ ì €ì¶•ë³´í—˜' },
                { value: 'ì—°ê¸ˆ', label: 'ğŸ‘´ ì—°ê¸ˆ' },
                { value: 'íˆ¬ì', label: 'ğŸ“ˆ íˆ¬ì' },
                { value: 'ê¸°íƒ€_ì €ì¶•', label: 'ğŸ“¦ ê¸°íƒ€' }
            ],
            fixed: [
                { value: 'ë³´ì¥ì„±ë³´í—˜', label: 'ğŸ›¡ï¸ ë³´ì¥ì„±ë³´í—˜' },
                { value: 'ê³µê³¼ê¸ˆ', label: 'ğŸ’¡ ê³µê³¼ê¸ˆ' },
                { value: 'í†µì‹ ë¹„', label: 'ğŸ“± í†µì‹ ë¹„' },
                { value: 'ê´€ë¦¬ë¹„', label: 'ğŸ¢ ê´€ë¦¬ë¹„' },
                { value: 'ì›”ì„¸', label: 'ğŸ  ì›”ì„¸' },
                { value: 'ëŒ€ì¶œì´ì', label: 'ğŸ›ï¸ ëŒ€ì¶œì´ì' },
                { value: 'ê¸°íƒ€_ê³ ì •', label: 'ğŸ“¦ ê¸°íƒ€' }
            ]
        };

        function getTodayDateString() { return new Date().toISOString().split('T')[0]; }
        function formatAmount(amount) { return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›'; }

        function updateCategoryOptions(type, targetSelect, selectedValue = null) {
            targetSelect.innerHTML = '';
            const categoryList = categories[type] || categories.expense;
            categoryList.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.value;
                option.textContent = cat.label;
                if (selectedValue === cat.value) option.selected = true;
                targetSelect.appendChild(option);
            });
        }

        function clearInputFields() {
            document.getElementById('budgetDate').value = getTodayDateString();
            document.getElementById('budgetType').value = 'expense';
            document.getElementById('budgetAmount').value = '';
            document.getElementById('budgetMemo').value = '';
            updateCategoryOptions('expense', document.getElementById('budgetCategory'));
        }

        function showPage(pageNumber) {
            currentPage = Math.min(Math.max(pageNumber, 1), totalPages);
            document.querySelectorAll('.page-content').forEach(el => el.classList.remove('active'));
            document.getElementById('page' + currentPage).classList.add('active');
            // 4 ê±´ë„ˆë›°ê³  í‘œì‹œ (1,2,3,5)
            const displayPage = currentPage === 4 ? 5 : currentPage;
            document.getElementById('pageIndicator').textContent = displayPage + ' / 5';
            document.getElementById('prevPageBtn').disabled = (currentPage === 1);
            document.getElementById('nextPageBtn').disabled = (currentPage === totalPages);
            if (currentPage === 1) refreshAllData();
            if (currentPage === 2) renderMonthlyLedgersView();
            if (currentPage === 3) { calculateFiveYearStats(); loadGoal(); }
            if (currentPage === 4) renderFixedItems();
        }

        async function saveBudget() {
            const date = document.getElementById('budgetDate').value;
            const type = document.getElementById('budgetType').value;
            const amount = parseInt(document.getElementById('budgetAmount').value, 10);
            const category = document.getElementById('budgetCategory').value;
            const memo = document.getElementById('budgetMemo').value.trim();
            if (!date || !type || !amount || !category || amount <= 0) { alert('í•„ìˆ˜ í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            try {
                await db.budgets.add({ timestamp: new Date().getTime(), date, type, amount, category, memo });
                clearInputFields();
                refreshAllData();
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) { alert('ì €ì¥ ì˜¤ë¥˜: ' + error.message); }
        }

        async function calculateTotalBalance() {
            const allBudgets = await db.budgets.toArray();
            const currentYear = new Date().getFullYear().toString();
            const yearlyData = allBudgets.filter(entry => entry.date && entry.date.length >= 4 && entry.date.substring(0, 4) === currentYear);
            let income = 0, expense = 0;
            yearlyData.forEach(entry => { if (entry.type === 'income') income += entry.amount; else expense += entry.amount; });
            const balance = income - expense;
            document.getElementById('currentBalance').textContent = formatAmount(balance);
            localStorage.setItem('moneyBalance', balance);
            if (window.parent !== window) window.parent.postMessage({ type: 'statsUpdate' }, '*');
        }

        async function updateMonthlyStats() {
            const today = getTodayDateString();
            const currentMonth = today.substring(0, 7);
            const allBudgets = await db.budgets.toArray();
            const monthlyData = allBudgets.filter(entry => entry.date.startsWith(currentMonth));
            let income = 0, expense = 0;
            const dailyExpenses = {};
            
            // ìœ í˜•ë³„ í•©ê³„
            let typeIncome = 0, typeExpense = 0, typeSaving = 0, typeFixed = 0;
            
            monthlyData.forEach(entry => {
                if (entry.type === 'income') {
                    income += entry.amount;
                    typeIncome += entry.amount;
                } else {
                    expense += entry.amount;
                    dailyExpenses[entry.date] = (dailyExpenses[entry.date] || 0) + entry.amount;
                    
                    // ìœ í˜•ë³„ ë¶„ë¥˜
                    if (entry.type === 'expense') typeExpense += entry.amount;
                    else if (entry.type === 'saving') typeSaving += entry.amount;
                    else if (entry.type === 'fixed') typeFixed += entry.amount;
                }
            });
            
            document.getElementById('monthlyIncome').textContent = formatAmount(income);
            document.getElementById('monthlyExpense').textContent = formatAmount(expense);
            document.getElementById('monthlyBalance').textContent = formatAmount(income - expense);
            
            // ìœ í˜•ë³„ í˜„í™© í‘œ ì—…ë°ì´íŠ¸
            document.getElementById('typeIncome').textContent = '+' + formatAmount(typeIncome);
            document.getElementById('typeExpense').textContent = typeExpense > 0 ? '-' + formatAmount(typeExpense) : '0ì›';
            document.getElementById('typeSaving').textContent = typeSaving > 0 ? '-' + formatAmount(typeSaving) : '0ì›';
            document.getElementById('typeFixed').textContent = typeFixed > 0 ? '-' + formatAmount(typeFixed) : '0ì›';
            const totalBalance = typeIncome - typeExpense - typeSaving - typeFixed;
            document.getElementById('typeTotal').textContent = (totalBalance >= 0 ? '+' : '') + formatAmount(totalBalance);
            
            localStorage.setItem('moneyMonthlyBalance', income - expense);
            if (window.parent !== window) window.parent.postMessage({ type: 'statsUpdate' }, '*');
            renderDailyExpenseChart(dailyExpenses);
        }

        function renderDailyExpenseChart(dailyExpenses) {
            if (dailyExpenseChartInstance) dailyExpenseChartInstance.destroy();
            const dates = Object.keys(dailyExpenses).sort();
            const amounts = dates.map(date => dailyExpenses[date]);
            const ctx = document.getElementById('dailyExpenseChart').getContext('2d');
            dailyExpenseChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: dates.map(d => d.substring(5)), datasets: [{ label: 'ì¼ë³„ ì§€ì¶œ', data: amounts, backgroundColor: 'rgba(239, 68, 68, 0.7)', borderColor: 'rgba(239, 68, 68, 1)', borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
            });
        }

        async function renderMonthlyLedgersView() {
            const allBudgets = await db.budgets.toArray();
            const monthlyLedgers = {};
            allBudgets.forEach(entry => { const month = entry.date.substring(0, 7); if (!monthlyLedgers[month]) monthlyLedgers[month] = []; monthlyLedgers[month].push(entry); });
            const sortedMonths = Object.keys(monthlyLedgers).sort().reverse();
            const container = document.getElementById('monthlyLedgersContent');
            if (sortedMonths.length === 0) { container.innerHTML = '<div class="empty-state"><i class="fas fa-receipt"></i><p>ê¸°ë¡ëœ ì¥ë¶€ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>'; return; }
            let html = '';
            sortedMonths.forEach(month => {
                const entries = monthlyLedgers[month].sort((a, b) => new Date(b.date) - new Date(a.date));
                let incomeTotal = 0, expenseTotal = 0;
                entries.forEach(entry => { if (entry.type === 'income') incomeTotal += entry.amount; else expenseTotal += entry.amount; });
                html += '<div class="ledger-month"><div class="ledger-month-header">' + month + '</div><div class="ledger-month-stats"><span class="income-text">ìˆ˜ì…: ' + formatAmount(incomeTotal) + '</span><span class="expense-text">ì§€ì¶œ: ' + formatAmount(expenseTotal) + '</span></div><table class="ledger-table"><thead><tr><th>ë‚ ì§œ</th><th>ë¶„ë¥˜</th><th>ê¸ˆì•¡</th><th></th></tr></thead><tbody>';
                entries.forEach(entry => {
                    const categoryList = categories[entry.type] || categories.expense;
                    const categoryLabel = categoryList.find(c => c.value === entry.category)?.label || entry.category;
                    const textClass = entry.type === 'income' ? 'income-text' : entry.type === 'saving' ? 'saving-text' : entry.type === 'fixed' ? 'fixed-text' : 'expense-text';
                    html += '<tr><td>' + entry.date.substring(5) + '</td><td class="' + textClass + '">' + categoryLabel + '</td><td class="' + textClass + '">' + formatAmount(entry.amount) + '</td><td><button class="btn btn-sm btn-secondary" onclick="openBudgetModal(' + entry.id + ')"><i class="fas fa-edit"></i></button></td></tr>';
                });
                html += '</tbody></table></div>';
            });
            container.innerHTML = html;
        }

        async function openBudgetModal(id) {
            currentEditingId = id;
            const entry = await db.budgets.get(id);
            if (!entry) { alert('ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = '<div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="modalDate" class="form-input" value="' + entry.date + '"></div><div class="form-group"><label>ìœ í˜•</label><select id="modalType" class="form-select"><option value="income"' + (entry.type === 'income' ? ' selected' : '') + '>ìˆ˜ì…</option><option value="expense"' + (entry.type === 'expense' ? ' selected' : '') + '>ì¼ë°˜ì§€ì¶œ</option><option value="saving"' + (entry.type === 'saving' ? ' selected' : '') + '>ì €ì¶•ì„±ì§€ì¶œ</option><option value="fixed"' + (entry.type === 'fixed' ? ' selected' : '') + '>ë¹„ì €ì¶•ì„±ì§€ì¶œ</option></select></div><div class="form-group"><label>ê¸ˆì•¡</label><input type="number" id="modalAmount" class="form-input" value="' + entry.amount + '"></div><div class="form-group"><label>ì¹´í…Œê³ ë¦¬</label><select id="modalCategory" class="form-select"></select></div><div class="form-group"><label>ë©”ëª¨</label><textarea id="modalMemo" class="form-textarea">' + (entry.memo || '') + '</textarea></div><div class="action-buttons"><button class="btn btn-primary" onclick="saveModalBudget()"><i class="fas fa-save"></i> ìˆ˜ì •</button><button class="btn btn-danger" onclick="deleteBudgetEntry(' + id + ')"><i class="fas fa-trash"></i> ì‚­ì œ</button></div>';
            updateCategoryOptions(entry.type, document.getElementById('modalCategory'), entry.category);
            document.getElementById('modalType').onchange = (e) => { updateCategoryOptions(e.target.value, document.getElementById('modalCategory')); };
            document.getElementById('budgetModal').classList.add('active');
        }

        function closeModal() { document.getElementById('budgetModal').classList.remove('active'); }

        async function saveModalBudget() {
            if (!currentEditingId) return;
            const date = document.getElementById('modalDate').value;
            const type = document.getElementById('modalType').value;
            const amount = parseInt(document.getElementById('modalAmount').value, 10);
            const category = document.getElementById('modalCategory').value;
            const memo = document.getElementById('modalMemo').value.trim();
            if (!date || !amount || amount <= 0) { alert('í•„ìˆ˜ í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            try {
                const existing = await db.budgets.get(currentEditingId);
                await db.budgets.put({ id: currentEditingId, timestamp: existing.timestamp, date, type, amount, category, memo });
                closeModal(); refreshAllData(); renderMonthlyLedgersView();
            } catch (error) { alert('ìˆ˜ì • ì˜¤ë¥˜: ' + error.message); }
        }

        async function deleteBudgetEntry(id) {
            if (confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { await db.budgets.delete(id); closeModal(); refreshAllData(); renderMonthlyLedgersView(); }
        }

        async function loadGoal() {
            try {
                const goal = await db.goals.get(1);
                const displayArea = document.getElementById('goalDisplayArea');
                const editArea = document.getElementById('goalEditArea');
                const displayText = document.getElementById('goalDisplayText');
                const cancelBtn = document.getElementById('cancelGoalBtn');
                if (goal && goal.memo && goal.memo.trim() !== '') { displayText.textContent = goal.memo; displayArea.style.display = 'block'; editArea.style.display = 'none'; }
                else { displayArea.style.display = 'none'; editArea.style.display = 'block'; cancelBtn.style.display = 'none'; document.getElementById('goalMemoInput').value = ''; }
            } catch (error) { console.error(error); }
        }

        async function saveGoal() {
            const memo = document.getElementById('goalMemoInput').value.trim();
            if (!memo) { alert('ëª©í‘œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            try { await db.goals.put({ id: 1, memo: memo }); alert('ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¯'); loadGoal(); }
            catch (error) { alert('ì €ì¥ ì˜¤ë¥˜: ' + error.message); }
        }

        function editGoal() {
            const displayArea = document.getElementById('goalDisplayArea');
            const editArea = document.getElementById('goalEditArea');
            const displayText = document.getElementById('goalDisplayText');
            const cancelBtn = document.getElementById('cancelGoalBtn');
            document.getElementById('goalMemoInput').value = displayText.textContent;
            displayArea.style.display = 'none'; editArea.style.display = 'block'; cancelBtn.style.display = 'inline-flex';
        }

        function cancelEditGoal() { loadGoal(); }

        async function deleteGoal() {
            if (confirm('ëª©í‘œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { try { await db.goals.delete(1); alert('ëª©í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); loadGoal(); } catch (error) { alert('ì‚­ì œ ì˜¤ë¥˜: ' + error.message); } }
        }

        async function calculateFiveYearStats() {
            const allBudgets = await db.budgets.toArray();
            const annualStats = {};
            allBudgets.forEach(entry => { const year = entry.date.substring(0, 4); if (!annualStats[year]) annualStats[year] = { income: 0, expense: 0 }; if (entry.type === 'income') annualStats[year].income += entry.amount; else annualStats[year].expense += entry.amount; });
            const currentYear = new Date().getFullYear();
            const yearsToShow = [];
            for (let i = 0; i < 5; i++) yearsToShow.push((currentYear + i).toString());
            const container = document.getElementById('fiveYearStatsContent');
            if (Object.keys(annualStats).length === 0) { container.innerHTML = '<div class="empty-state" style="grid-column: 1 / -1;"><i class="fas fa-chart-bar"></i><p>í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>'; return; }
            let html = '';
            yearsToShow.forEach(year => {
                const stats = annualStats[year] || { income: 0, expense: 0 };
                const balance = stats.income - stats.expense;
                html += '<div class="year-stat-box"><div class="year">' + year + 'ë…„</div><div class="stat-row"><span>ìˆ˜ì…</span><span class="income-text">' + formatAmount(stats.income) + '</span></div><div class="stat-row"><span>ì§€ì¶œ</span><span class="expense-text">' + formatAmount(stats.expense) + '</span></div><div class="stat-row"><span>ìˆœìì‚°</span><span class="balance-text">' + formatAmount(balance) + '</span></div></div>';
            });
            container.innerHTML = html;
        }

        // Info Popup
        function showInfoPopup(type) {
            const titles = { income: 'ğŸ“¥ ê³ ì •ìˆ˜ì…', food: 'ğŸ½ï¸ í‰ê· ì›”ì‹ìì¬ë¹„', saving: 'ğŸ¦ ì €ì¶•ì„±ì§€ì¶œ', fixed: 'ğŸ’¡ ì˜ë¬´ì§€ì¶œ' };
            document.getElementById('infoPopupTitle').textContent = titles[type] || 'ğŸ’¡ í•´ë‹¹ í•­ëª© ì˜ˆì‹œ';
            document.getElementById('infoPopupText').textContent = tooltipDescriptions[type] || '';
            document.getElementById('infoPopup').classList.add('active');
        }
        function closeInfoPopup() { document.getElementById('infoPopup').classList.remove('active'); }
        
        // Page Notice Popup
        function showPageNotice() { document.getElementById('pageNoticePopup').classList.add('active'); }
        function closePageNotice() { document.getElementById('pageNoticePopup').classList.remove('active'); }

        // Page 4 Functions
        async function addFixedItem() {
            const type = document.getElementById('fixedType').value;
            const name = document.getElementById('fixedName').value.trim();
            const amount = parseInt(document.getElementById('fixedAmount').value, 10);
            const note = document.getElementById('fixedNote').value.trim();
            if (!name || !amount || amount <= 0) { alert('í•­ëª©ëª…ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            try {
                await db.fixedItems.add({ type, name, amount, note });
                document.getElementById('fixedName').value = '';
                document.getElementById('fixedAmount').value = '';
                document.getElementById('fixedNote').value = '';
                renderFixedItems();
                alert('í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) { alert('ì¶”ê°€ ì˜¤ë¥˜: ' + error.message); }
        }

        async function renderFixedItems() {
            const items = await db.fixedItems.toArray();
            const container = document.getElementById('fixedItemsList');
            const summaryContainer = document.getElementById('fixedSummary');
            const incomeItems = items.filter(i => i.type === 'income');
            const foodItems = items.filter(i => i.type === 'food');
            const savingItems = items.filter(i => i.type === 'saving');
            const fixedItems = items.filter(i => i.type === 'fixed');
            const incomeTotal = incomeItems.reduce((sum, i) => sum + i.amount, 0);
            const foodTotal = foodItems.reduce((sum, i) => sum + i.amount, 0);
            const savingTotal = savingItems.reduce((sum, i) => sum + i.amount, 0);
            const fixedTotal = fixedItems.reduce((sum, i) => sum + i.amount, 0);
            const totalExpense = foodTotal + savingTotal + fixedTotal;
            const remaining = incomeTotal - totalExpense;

            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-clipboard-list"></i><p>ë“±ë¡ëœ ê³ ì • í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</p><p style="font-size: 0.75rem; margin-top: 8px;">ìœ„ì—ì„œ í•­ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p></div>';
                summaryContainer.style.display = 'none';
                return;
            }

            let html = '';
            html += '<div class="section-box"><div class="section-header income-header"><h3><i class="fas fa-arrow-down"></i> ê³ ì •ìˆ˜ì… <button class="info-btn" onclick="showInfoPopup(\'income\')">?</button></h3><span class="section-total">' + formatAmount(incomeTotal) + '</span></div><div class="section-items">' + (incomeItems.length > 0 ? incomeItems.map(item => renderFixedItemRow(item, 'income')).join('') : '<div class="empty-section">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>') + '</div></div>';
            html += '<div class="section-box"><div class="section-header food-header"><h3><i class="fas fa-utensils"></i> í‰ê· ì›”ì‹ìì¬ë¹„ <button class="info-btn" onclick="showInfoPopup(\'food\')">?</button></h3><span class="section-total">' + formatAmount(foodTotal) + '</span></div><div class="section-items">' + (foodItems.length > 0 ? foodItems.map(item => renderFixedItemRow(item, 'food')).join('') : '<div class="empty-section">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>') + '</div></div>';
            html += '<div class="section-box"><div class="section-header saving-header"><h3><i class="fas fa-piggy-bank"></i> ì €ì¶•ì„±ì§€ì¶œ <button class="info-btn" onclick="showInfoPopup(\'saving\')">?</button></h3><span class="section-total">' + formatAmount(savingTotal) + '</span></div><div class="section-items">' + (savingItems.length > 0 ? savingItems.map(item => renderFixedItemRow(item, 'saving')).join('') : '<div class="empty-section">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>') + '</div></div>';
            html += '<div class="section-box"><div class="section-header fixed-header"><h3><i class="fas fa-file-invoice-dollar"></i> ì˜ë¬´ì§€ì¶œ <button class="info-btn" onclick="showInfoPopup(\'fixed\')">?</button></h3><span class="section-total">' + formatAmount(fixedTotal) + '</span></div><div class="section-items">' + (fixedItems.length > 0 ? fixedItems.map(item => renderFixedItemRow(item, 'fixed')).join('') : '<div class="empty-section">í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</div>') + '</div></div>';
            container.innerHTML = html;

            summaryContainer.style.display = 'block';
            summaryContainer.innerHTML = '<div class="summary-title">ğŸ“Š ì›”ê°„ ê³ ì • ìˆ˜ì…/ì§€ì¶œ ìš”ì•½</div><div class="summary-row with-border"><span class="label">ğŸ“¥ ì´ ê³ ì •ìˆ˜ì…</span><span class="value positive">+' + formatAmount(incomeTotal) + '</span></div><div class="summary-row"><span class="label">ğŸ½ï¸ í‰ê· ì›”ì‹ìì¬ë¹„</span><span class="value">' + formatAmount(foodTotal) + '</span></div><div class="summary-row"><span class="label">ğŸ¦ ì €ì¶•ì„±ì§€ì¶œ</span><span class="value">' + formatAmount(savingTotal) + '</span></div><div class="summary-row"><span class="label">ğŸ’¡ ì˜ë¬´ì§€ì¶œ</span><span class="value">' + formatAmount(fixedTotal) + '</span></div><div class="summary-row with-border"><span class="label">ğŸ“¤ ì´ ê³ ì •ì§€ì¶œ</span><span class="value negative">-' + formatAmount(totalExpense) + '</span></div><div class="summary-row highlight"><span class="label">ğŸ’° ì´ì›”ì•¡ (ê°€ìš©ê¸ˆì•¡)</span><span class="value ' + (remaining >= 0 ? 'positive' : 'negative') + '">' + (remaining >= 0 ? '+' : '') + formatAmount(remaining) + '</span></div>';
        }

        function renderFixedItemRow(item, typeClass) {
            return '<div class="fixed-item"><div class="item-info"><div class="item-name">' + item.name + '</div>' + (item.note ? '<div class="item-note">' + item.note + '</div>' : '') + '</div><div class="item-amount ' + typeClass + '">' + formatAmount(item.amount) + '</div><div class="item-actions"><button class="btn btn-sm btn-secondary" onclick="openFixedModal(' + item.id + ')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" onclick="deleteFixedItem(' + item.id + ')"><i class="fas fa-trash"></i></button></div></div>';
        }

        async function openFixedModal(id) {
            currentFixedEditingId = id;
            const item = await db.fixedItems.get(id);
            if (!item) { alert('í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const modalBody = document.getElementById('fixedModalBody');
            modalBody.innerHTML = '<div class="form-group"><label>ë¶„ë¥˜</label><select id="fixedModalType" class="form-select"><option value="income"' + (item.type === 'income' ? ' selected' : '') + '>ê³ ì •ìˆ˜ì…</option><option value="food"' + (item.type === 'food' ? ' selected' : '') + '>í‰ê· ì›”ì‹ìì¬ë¹„</option><option value="saving"' + (item.type === 'saving' ? ' selected' : '') + '>ì €ì¶•ì„±ì§€ì¶œ</option><option value="fixed"' + (item.type === 'fixed' ? ' selected' : '') + '>ì˜ë¬´ì§€ì¶œ</option></select></div><div class="form-group"><label>í•­ëª©ëª…</label><input type="text" id="fixedModalName" class="form-input" value="' + item.name + '"></div><div class="form-group"><label>ê¸ˆì•¡</label><input type="number" id="fixedModalAmount" class="form-input" value="' + item.amount + '"></div><div class="form-group"><label>ë¹„ê³ </label><input type="text" id="fixedModalNote" class="form-input" value="' + (item.note || '') + '"></div><div class="action-buttons"><button class="btn btn-primary" onclick="saveFixedModal()"><i class="fas fa-save"></i> ì €ì¥</button></div>';
            document.getElementById('fixedModal').classList.add('active');
        }

        function closeFixedModal() { document.getElementById('fixedModal').classList.remove('active'); }

        async function saveFixedModal() {
            if (!currentFixedEditingId) return;
            const type = document.getElementById('fixedModalType').value;
            const name = document.getElementById('fixedModalName').value.trim();
            const amount = parseInt(document.getElementById('fixedModalAmount').value, 10);
            const note = document.getElementById('fixedModalNote').value.trim();
            if (!name || !amount || amount <= 0) { alert('í•­ëª©ëª…ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            try { await db.fixedItems.put({ id: currentFixedEditingId, type, name, amount, note }); closeFixedModal(); renderFixedItems(); }
            catch (error) { alert('ìˆ˜ì • ì˜¤ë¥˜: ' + error.message); }
        }

        async function deleteFixedItem(id) { if (confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { await db.fixedItems.delete(id); renderFixedItems(); } }

        async function globalReset() {
            const confirmation = prompt('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ë ¤ë©´ "ì´ˆê¸°í™”"ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            if (confirmation === 'ì´ˆê¸°í™”') { await db.budgets.clear(); await db.goals.clear(); await db.fixedItems.clear(); alert('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.'); clearInputFields(); refreshAllData(); }
        }

        async function displayDataAsJson() {
            const budgets = await db.budgets.toArray();
            const goals = await db.goals.toArray();
            const fixedItems = await db.fixedItems.toArray();
            if (budgets.length === 0 && goals.length === 0 && fixedItems.length === 0) { alert('ë°±ì—…í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
            const data = JSON.stringify({ budgets, goals, fixedItems }, null, 2);
            const win = window.open("", "_blank", "width=600,height=600");
            win.document.write('<h2>ë°±ì—… ë°ì´í„°</h2><p style="color: #666;">ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•˜ì—¬ ë©”ëª¨ì¥ì— ì €ì¥í•˜ì„¸ìš”.</p><textarea style="width: 100%; height: 80%; font-size: 12px;">' + data + '</textarea>');
            win.document.close();
        }

        async function importDataFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm('ë³µì› ì‹œ ê¸°ì¡´ ë°ì´í„°ê°€ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { event.target.value = ''; return; }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    await db.budgets.clear(); await db.goals.clear(); await db.fixedItems.clear();
                    if (data.budgets?.length > 0) { const budgetsToAdd = data.budgets.map(b => { const { id, ...rest } = b; return rest; }); await db.budgets.bulkAdd(budgetsToAdd); }
                    if (data.goals?.length > 0) { await db.goals.put({ id: 1, memo: data.goals[0].memo }); }
                    if (data.fixedItems?.length > 0) { const fixedToAdd = data.fixedItems.map(f => { const { id, ...rest } = f; return rest; }); await db.fixedItems.bulkAdd(fixedToAdd); }
                    alert('ë³µì› ì™„ë£Œ!'); refreshAllData(); loadGoal(); renderFixedItems();
                } catch (error) { alert('ë³µì› ì‹¤íŒ¨: ' + error.message); }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function refreshAllData() { calculateTotalBalance(); updateMonthlyStats(); }

        function initializeApp() {
            updateCategoryOptions('expense', document.getElementById('budgetCategory'));
            document.getElementById('budgetDate').value = getTodayDateString();
            document.getElementById('budgetType').addEventListener('change', (e) => { updateCategoryOptions(e.target.value, document.getElementById('budgetCategory')); });
            document.getElementById('saveBudgetBtn').addEventListener('click', saveBudget);
            document.getElementById('clearInputBtn').addEventListener('click', clearInputFields);
            document.getElementById('saveGoalBtn').addEventListener('click', saveGoal);
            document.getElementById('editGoalBtn').addEventListener('click', editGoal);
            document.getElementById('deleteGoalBtn').addEventListener('click', deleteGoal);
            document.getElementById('cancelGoalBtn').addEventListener('click', cancelEditGoal);
            document.getElementById('globalResetBtn').addEventListener('click', globalReset);
            document.getElementById('addFixedBtn').addEventListener('click', addFixedItem);
            document.getElementById('prevPageBtn').addEventListener('click', () => showPage(currentPage - 1));
            document.getElementById('nextPageBtn').addEventListener('click', () => showPage(currentPage + 1));
            window.onclick = (e) => { 
                if (e.target === document.getElementById('budgetModal')) closeModal(); 
                if (e.target === document.getElementById('fixedModal')) closeFixedModal(); 
                if (e.target === document.getElementById('infoPopup')) closeInfoPopup();
                if (e.target === document.getElementById('pageNoticePopup')) closePageNotice();
            };
            refreshAllData();
            showPage(1);
        }

        window.onload = initializeApp;
        window.openBudgetModal = openBudgetModal;
        window.saveModalBudget = saveModalBudget;
        window.deleteBudgetEntry = deleteBudgetEntry;
        window.closeModal = closeModal;
        window.openFixedModal = openFixedModal;
        window.saveFixedModal = saveFixedModal;
        window.deleteFixedItem = deleteFixedItem;
        window.closeFixedModal = closeFixedModal;
        window.showInfoPopup = showInfoPopup;
        window.closeInfoPopup = closeInfoPopup;
        window.showPageNotice = showPageNotice;
        window.closePageNotice = closePageNotice;
        window.displayDataAsJson = displayDataAsJson;
        window.importDataFromJson = importDataFromJson;

        // ë°±ì—… ì„¹ì…˜ ì ‘ê¸°/í¼ì¹˜ê¸°
        function toggleBackupSection() {
            const section = document.getElementById('backupSection');
            const icon = document.getElementById('backupToggleIcon');
            const text = document.getElementById('backupToggleText');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                text.textContent = 'ë°±ì—…/ì´ˆê¸°í™” ì„¹ì…˜ ì ‘ê¸°';
            } else {
                section.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
                text.textContent = 'ë°±ì—…/ì´ˆê¸°í™” ì„¹ì…˜ í¼ì¹˜ê¸°';
            }
        }
        window.toggleBackupSection = toggleBackupSection;

        // ì´ì „ ë…„ë„ ë³´ê¸° í† ê¸€
        function togglePastYears() {
            const section = document.getElementById('pastYearsSection');
            const text = document.getElementById('pastYearsText');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                text.textContent = 'ì´ì „ ë…„ë„ ì ‘ê¸°';
                loadPastYears();
            } else {
                section.style.display = 'none';
                text.textContent = 'ì´ì „ ë…„ë„ ë³´ê¸°';
            }
        }
        window.togglePastYears = togglePastYears;

        // ì´ì „ ë…„ë„ ë°ì´í„° ë¡œë“œ
        async function loadPastYears() {
            const allBudgets = await db.budgets.toArray();
            const annualStats = {};
            allBudgets.forEach(entry => {
                const year = entry.date.substring(0, 4);
                if (!annualStats[year]) annualStats[year] = { income: 0, expense: 0 };
                if (entry.type === 'income') annualStats[year].income += entry.amount;
                else annualStats[year].expense += entry.amount;
            });
            
            const currentYear = new Date().getFullYear();
            const pastYears = Object.keys(annualStats)
                .map(y => parseInt(y))
                .filter(y => y < currentYear)
                .sort((a, b) => b - a);
            
            const container = document.getElementById('pastYearsContent');
            
            if (pastYears.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><p>ì´ì „ ë…„ë„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
                return;
            }
            
            let html = '';
            pastYears.forEach(year => {
                const stats = annualStats[year];
                const balance = stats.income - stats.expense;
                html += '<div class="year-stat-box"><div class="year">' + year + 'ë…„</div><div class="stat-row"><span>ìˆ˜ì…</span><span class="income-text">' + formatAmount(stats.income) + '</span></div><div class="stat-row"><span>ì§€ì¶œ</span><span class="expense-text">' + formatAmount(stats.expense) + '</span></div><div class="stat-row"><span>ìˆœìì‚°</span><span class="balance-text">' + formatAmount(balance) + '</span></div></div>';
            });
            container.innerHTML = html;
        }

        // ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        async function downloadBackupFile() {
            const budgets = await db.budgets.toArray();
            const goals = await db.goals.toArray();
            const fixedItems = await db.fixedItems.toArray();
            
            if (budgets.length === 0 && goals.length === 0 && fixedItems.length === 0) {
                alert('ë°±ì—…í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const data = JSON.stringify({ budgets, goals, fixedItems }, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const today = new Date().toISOString().slice(0, 10);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ê°€ê³„ë¶€_ë°±ì—…_${today}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('ë°±ì—… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
        }
        window.downloadBackupFile = downloadBackupFile;

        // ëª¨ë°”ì¼ ë°±ì—… (ê³µìœ í•˜ê¸°)
        async function mobileBackup() {
            const budgets = await db.budgets.toArray();
            const goals = await db.goals.toArray();
            const fixedItems = await db.fixedItems.toArray();
            
            if (budgets.length === 0 && goals.length === 0 && fixedItems.length === 0) {
                alert('ë°±ì—…í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const data = JSON.stringify({ budgets, goals, fixedItems }, null, 2);
            const today = new Date().toISOString().slice(0, 10);
            const fileName = `ê°€ê³„ë¶€_ë°±ì—…_${today}.json`;
            
            // Web Share API ì§€ì› í™•ì¸
            if (navigator.share && navigator.canShare) {
                const file = new File([data], fileName, { type: 'application/json' });
                
                if (navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'ê°€ê³„ë¶€ ë°±ì—…',
                            text: 'ê°€ê³„ë¶€ ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.'
                        });
                        return;
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.log('íŒŒì¼ ê³µìœ  ì‹¤íŒ¨, í…ìŠ¤íŠ¸ ê³µìœ  ì‹œë„');
                        } else {
                            return;
                        }
                    }
                }
                
                // íŒŒì¼ ê³µìœ  ì•ˆ ë˜ë©´ í…ìŠ¤íŠ¸ë¡œ ê³µìœ 
                try {
                    await navigator.share({
                        title: 'ê°€ê³„ë¶€ ë°±ì—…',
                        text: data
                    });
                    return;
                } catch (err) {
                    if (err.name === 'AbortError') return;
                }
            }
            
            // Share API ì§€ì› ì•ˆ í•˜ë©´ í´ë¦½ë³´ë“œ ë³µì‚¬
            try {
                await navigator.clipboard.writeText(data);
                alert('ë°±ì—… ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì¹´ì¹´ì˜¤í†¡ "ë‚˜ì—ê²Œ ë³´ë‚´ê¸°" ë˜ëŠ” ë©”ëª¨ì•±ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
            } catch (err) {
                // í´ë¦½ë³´ë“œë„ ì•ˆ ë˜ë©´ ê¸°ì¡´ ë°©ì‹
                displayDataAsJson();
            }
        }
        window.mobileBackup = mobileBackup;
    </script>
</body>
</html>
