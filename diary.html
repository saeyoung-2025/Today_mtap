<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¼ê¸° - Today App</title>
    <link rel="icon" type="image/png" href="icon-192.png">
    <script src="https://unpkg.com/dexie@3.2.3/dist/dexie.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #FAFAFA;
            --bg-secondary: #FFFFFF;
            --bg-card: #FFFFFF;
            --text-primary: #1A1A1A;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --border-color: #E5E7EB;
            --accent: #3B82F6;
            --accent-light: #EFF6FF;
            --success: #10B981;
            --success-light: #D1FAE5;
            --danger: #EF4444;
            --danger-light: #FEE2E2;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: all 0.2s ease;
        }

        body.theme-gray {
            --bg-primary: #F3F4F6;
            --bg-secondary: #E5E7EB;
            --bg-card: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #4B5563;
            --text-muted: #9CA3AF;
            --border-color: #D1D5DB;
            --accent: #6366F1;
            --accent-light: #EEF2FF;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
            transition: var(--transition);
        }

        .container { max-width: 100%; }

        .page-header { text-align: center; margin-bottom: 20px; }
        .page-header h1 { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .page-header h1 i { color: var(--accent); margin-right: 8px; }

        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }

        .nav-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-btn:hover:not(:disabled) { background: var(--accent); color: white; border-color: var(--accent); }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .page-indicator { font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title i { color: var(--accent); }

        .page-content { display: none; }
        .page-content.active { display: block; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.9rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-card);
        }

        .form-textarea { min-height: 120px; resize: vertical; }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-secondary); }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { opacity: 0.9; }
        .btn-sm { padding: 6px 12px; font-size: 0.75rem; }

        .mood-group { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .mood-group .form-select { flex: 1; min-width: 120px; }

        .search-group { display: flex; gap: 8px; margin-bottom: 16px; }
        .search-group input { flex: 1; }

        .diary-entry {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            transition: var(--transition);
        }

        .diary-entry:hover { border-color: var(--accent); }

        .diary-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .diary-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px; }
        .diary-mood { font-size: 1.25rem; }
        .diary-date { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 8px; }
        .diary-content { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; max-height: 60px; overflow: hidden; text-overflow: ellipsis; }
        .diary-actions { display: flex; gap: 8px; margin-top: 12px; }

        .empty-state { text-align: center; color: var(--text-muted); padding: 40px 20px; }
        .empty-state i { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.5; }

        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-box { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; text-align: center; }
        .stat-box .label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px; }
        .stat-box .value { font-size: 1.5rem; font-weight: 700; color: var(--accent); }

        .mood-stats { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 12px; margin-top: 16px; }
        .mood-item { text-align: center; }
        .mood-item .emoji { font-size: 1.5rem; }
        .mood-item .count { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }

        .monthly-list { max-height: 300px; overflow-y: auto; }
        .monthly-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
        .monthly-item:last-child { border-bottom: none; }
        .monthly-item span:last-child { font-weight: 600; color: var(--accent); }

        .action-buttons { display: flex; gap: 12px; margin-top: 16px; }
        .action-buttons .btn { flex: 1; }

        .danger-card { border-color: var(--danger); background: var(--danger-light); }
        .danger-card .card-title { color: var(--danger); }
        .danger-card p { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px; }

        .load-more-btn { width: 100%; padding: 12px; margin-top: 12px; }

        .backup-card { border-color: var(--accent); }
        .backup-card p { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.5; }
        .backup-btn-group { display: flex; flex-direction: column; gap: 8px; }
        .backup-btn-group .btn { width: 100%; justify-content: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-book"></i>ì¼ê¸°</h1>
        </div>

        <div class="nav-bar">
            <button id="prevPageBtn" class="nav-btn"><i class="fas fa-chevron-left"></i> ì´ì „</button>
            <span class="page-indicator" id="pageIndicator">1 / 3</span>
            <button id="nextPageBtn" class="nav-btn">ë‹¤ìŒ <i class="fas fa-chevron-right"></i></button>
        </div>

        <!-- Page 1: Write & List -->
        <div id="page1" class="page-content active">
            <div class="card">
                <div class="card-title"><i class="fas fa-pen"></i>ì¼ê¸° ì‘ì„±</div>
                <div class="form-group">
                    <input type="text" id="title" class="form-input" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div class="form-group">
                    <textarea id="content" class="form-textarea" placeholder="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ê¸°ë¡í•´ ë³´ì„¸ìš”..."></textarea>
                </div>
                <div class="mood-group">
                    <label style="margin: 0; font-size: 0.85rem;">ì˜¤ëŠ˜ì˜ ê¸°ë¶„:</label>
                    <select id="moodSelect" class="form-select">
                        <option value="ì¢‹ìŒ">ğŸ˜„ ì¢‹ìŒ</option>
                        <option value="ë³´í†µ" selected>ğŸ™‚ ë³´í†µ</option>
                        <option value="ë‚˜ì¨">ğŸ™ ë‚˜ì¨</option>
                        <option value="ìŠ¬í””">ğŸ˜­ ìŠ¬í””</option>
                        <option value="í™”ë‚¨">ğŸ˜¡ í™”ë‚¨</option>
                    </select>
                    <button id="saveDiaryBtn" class="btn btn-primary"><i class="fas fa-save"></i> ì €ì¥</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-list"></i>ìµœê·¼ ì¼ê¸°</div>
                <div class="search-group">
                    <input type="text" id="searchQuery" class="form-input" placeholder="ì œëª©/ë‚´ìš©/ë‚ ì§œ ê²€ìƒ‰">
                    <button id="searchBtn" class="btn btn-secondary btn-sm">ê²€ìƒ‰</button>
                    <button id="listBtn" class="btn btn-secondary btn-sm">ì „ì²´</button>
                </div>
                <div id="diaryList">
                    <div class="empty-state">
                        <i class="fas fa-book-open"></i>
                        <p>ì €ì¥ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
                <button id="loadMoreBtn" class="btn btn-secondary load-more-btn" style="display: none;">ë”ë³´ê¸°</button>
            </div>
        </div>

        <!-- Page 2: Statistics -->
        <div id="page2" class="page-content">
            <div class="card">
                <div class="card-title"><i class="fas fa-chart-bar"></i>ì¼ê¸° í†µê³„</div>
                <div class="stats-grid">
                    <div class="stat-box"><div class="label">ì´ë²ˆ ë‹¬</div><div class="value" id="thisMonthCount">0</div></div>
                    <div class="stat-box"><div class="label">ì˜¬í•´</div><div class="value" id="thisYearCount">0</div></div>
                    <div class="stat-box"><div class="label">ì „ì²´</div><div class="value" id="totalCount">0</div></div>
                    <div class="stat-box"><div class="label">ì›” í‰ê· </div><div class="value" id="avgPerMonth">0</div></div>
                </div>
                <div class="card-title" style="margin-top: 20px;"><i class="fas fa-face-smile"></i>ê¸°ë¶„ í†µê³„</div>
                <div class="mood-stats" id="moodStats"></div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-calendar"></i>ì›”ë³„ ì¼ê¸° ìˆ˜</div>
                <div class="monthly-list" id="monthlyStats"></div>
            </div>
            
            <!-- ì´ì „ ë…„ë„ ë³´ê¸° -->
            <button class="btn btn-secondary" onclick="togglePastYears()" style="width: 100%; margin-bottom: 12px; background: white; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <i class="fas fa-history" id="pastYearsIcon"></i> 
                <span id="pastYearsText">ì´ì „ ë…„ë„ ë³´ê¸°</span>
            </button>
            <div id="pastYearsSection" style="display: none;"></div>
        </div>

        <!-- Page 3: Settings -->
        <div id="page3" class="page-content">
            <div class="card">
                <div class="card-title"><i class="fas fa-bullseye"></i>ë‚˜ì˜ ë‹¤ì§</div>
                <div id="goalDisplayArea" style="display: none;">
                    <div id="goalDisplayText" style="background: var(--bg-primary); padding: 16px; border-radius: var(--radius-md); margin-bottom: 16px; line-height: 1.6; white-space: pre-wrap;"></div>
                    <div class="action-buttons">
                        <button id="editGoalBtn" class="btn btn-primary"><i class="fas fa-edit"></i> ìˆ˜ì •</button>
                        <button id="deleteGoalBtn" class="btn btn-danger"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                    </div>
                </div>
                <div id="goalEditArea">
                    <div class="form-group">
                        <textarea id="goalMemoInput" class="form-textarea" placeholder="ì¼ê¸° ì‘ì„± ëª©í‘œë‚˜ ë‹¤ì§ì„ ì ì–´ë³´ì„¸ìš”..."></textarea>
                    </div>
                    <div class="action-buttons">
                        <button id="saveGoalBtn" class="btn btn-primary"><i class="fas fa-save"></i> ì €ì¥</button>
                        <button id="cancelGoalBtn" class="btn btn-secondary" style="display: none;"><i class="fas fa-times"></i> ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>

            <!-- ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ -->
            <button class="btn btn-secondary" onclick="toggleBackupSection()" style="width: 100%; margin-bottom: 12px; background: white; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <i class="fas fa-chevron-down" id="backupToggleIcon"></i> 
                <span id="backupToggleText">ë°±ì—…/ì´ˆê¸°í™” ì„¹ì…˜ í¼ì¹˜ê¸°</span>
            </button>
            
            <div id="backupSection" style="display: none;">
                <div class="card backup-card">
                    <div class="card-title"><i class="fas fa-cloud"></i>ë°ì´í„° ë°±ì—…/ë³µì›</div>
                    <p style="font-size: 0.85rem; line-height: 1.6;">ğŸ’¾ ëª¨ë“  ì¼ê¸°ëŠ” <strong>ì˜êµ¬ ì €ì¥</strong>ë©ë‹ˆë‹¤. í™”ë©´ì—ëŠ” í˜„ì¬ ë…„ë„ í†µê³„ë§Œ í‘œì‹œë˜ì§€ë§Œ, ì´ì „ ë…„ë„ëŠ” 2í˜ì´ì§€ 'ì´ì „ ë…„ë„ ë³´ê¸°'ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">ìƒˆ ë””ë°”ì´ìŠ¤ ì‚¬ìš© ì‹œ ë°±ì—…/ë³µì›ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                    
                    <div style="background: var(--bg-primary); padding: 12px; border-radius: 8px; margin: 12px 0; font-size: 0.8rem; line-height: 1.6;">
                        <p>ğŸ’» <strong>PC</strong>: 'PC ë°±ì—…' í´ë¦­ â†’ í…ìŠ¤íŠ¸ë¥¼ ë©”ëª¨ì¥ì— ì €ì¥</p>
                        <p style="margin-top: 6px;">ğŸ“± <strong>ëª¨ë°”ì¼</strong>: 'ëª¨ë°”ì¼ ë°±ì—…' í´ë¦­ â†’ ì¹´í†¡ ë‚˜ì—ê²Œ ë³´ë‚´ê¸° ë˜ëŠ” ë©”ì¼ë¡œ ì „ì†¡</p>
                        <p style="margin-top: 6px;">ğŸ”„ <strong>ë³µì›</strong>: ì €ì¥í•œ íŒŒì¼(.json ë˜ëŠ” .txt)ì„ ì„ íƒí•˜ì—¬ ë³µì›</p>
                    </div>
                    
                    <div class="backup-btn-group">
                        <button class="btn btn-primary" onclick="displayDataAsJson()"><i class="fas fa-desktop"></i> PC ë°±ì—…</button>
                        <button class="btn btn-primary" onclick="mobileBackup()"><i class="fas fa-mobile-alt"></i> ëª¨ë°”ì¼ ë°±ì—…</button>
                        <input type="file" id="backupFileInput" accept=".json, .txt" style="display: none;" onchange="importDataFromJson(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('backupFileInput').click()"><i class="fas fa-upload"></i> ë°±ì—… íŒŒì¼ ë³µì›</button>
                    </div>
                </div>

                <div class="card danger-card">
                    <div class="card-title"><i class="fas fa-exclamation-triangle"></i>ìœ„í—˜ êµ¬ì—­</div>
                    <p>ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ëª¨ë“  ì¼ê¸° ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.</p>
                    <button id="globalResetBtn" class="btn btn-danger" style="width: 100%;"><i class="fas fa-trash"></i> ëª¨ë“  ì¼ê¸° ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme handling
        window.addEventListener('message', (event) => {
            if (event.data.type === 'themeChange') {
                document.body.classList.remove('theme-gray');
                if (event.data.theme === 'gray') document.body.classList.add('theme-gray');
            }
        });

        const savedTheme = localStorage.getItem('today_app_theme');
        if (savedTheme === 'gray') document.body.classList.add('theme-gray');

        // Database
        const db = new Dexie('StableDiaryDB_InitialDesign');
        db.version(56).stores({
            diaries: '++id, title, content, date, mood',
            goals: 'id'
        });

        const moodMap = { 'ì¢‹ìŒ': 'ğŸ˜„', 'ë³´í†µ': 'ğŸ™‚', 'ë‚˜ì¨': 'ğŸ™', 'ìŠ¬í””': 'ğŸ˜­', 'í™”ë‚¨': 'ğŸ˜¡' };

        const ENTRIES_PER_PAGE = 5;
        let currentDisplayLimit = ENTRIES_PER_PAGE;
        let isSearching = false;
        let currentPage = 1;
        const totalPages = 3;

        function showPage(pageNumber) {
            currentPage = Math.min(Math.max(pageNumber, 1), totalPages);
            document.querySelectorAll('.page-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`page${currentPage}`).classList.add('active');
            document.getElementById('pageIndicator').textContent = `${currentPage} / ${totalPages}`;
            document.getElementById('prevPageBtn').disabled = (currentPage === 1);
            document.getElementById('nextPageBtn').disabled = (currentPage === totalPages);
            if (currentPage === 2) updateStats();
            if (currentPage === 3) loadGoal();
        }

        function formatDate(isoDate) {
            const date = new Date(isoDate);
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', weekday: 'short', hour: '2-digit', minute: '2-digit', hour12: true };
            return date.toLocaleDateString('ko-KR', options);
        }

        async function saveDiary() {
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();
            const mood = document.getElementById('moodSelect').value;
            if (title === '' || content === '') { alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
            try {
                await db.diaries.add({ title, content, date: new Date().toISOString(), mood });
                document.getElementById('title').value = '';
                document.getElementById('content').value = '';
                document.getElementById('moodSelect').value = 'ë³´í†µ';
                isSearching = false;
                currentDisplayLimit = ENTRIES_PER_PAGE;
                document.getElementById('searchQuery').value = '';
                renderDiaryList();
                alert('ì¼ê¸°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“');
            } catch (error) { alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); console.error(error); }
        }

        async function deleteDiary(id) {
            if (confirm('ì´ ì¼ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try { await db.diaries.delete(id); renderDiaryList(); } catch (error) { console.error(error); }
            }
        }

        async function renderDiaryList(query = null) {
            const diaryListElement = document.getElementById('diaryList');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            let allDiaries;
            try {
                if (query && query.trim() !== '') {
                    isSearching = true;
                    const searchLower = query.trim().toLowerCase();
                    allDiaries = await db.diaries.filter(diary => {
                        const formattedDate = formatDate(diary.date).toLowerCase();
                        return diary.title.toLowerCase().includes(searchLower) || diary.content.toLowerCase().includes(searchLower) || formattedDate.includes(searchLower);
                    }).reverse().toArray();
                } else {
                    isSearching = false;
                    allDiaries = await db.diaries.orderBy('id').reverse().toArray();
                }
            } catch (e) { allDiaries = []; }
            
            diaryListElement.innerHTML = '';
            if (allDiaries.length === 0) {
                diaryListElement.innerHTML = `<div class="empty-state"><i class="fas fa-book-open"></i><p>${isSearching ? 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤' : 'ì €ì¥ëœ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤'}</p></div>`;
                loadMoreBtn.style.display = 'none';
                return;
            }

            const diariesToDisplay = allDiaries.slice(0, currentDisplayLimit);
            diariesToDisplay.forEach(diary => {
                const entryElement = document.createElement('div');
                entryElement.className = 'diary-entry';
                const formattedDate = formatDate(diary.date);
                const moodEmoji = moodMap[diary.mood] || 'â“';
                entryElement.innerHTML = `
                    <div class="diary-header"><div class="diary-title">${diary.title}<span class="diary-mood">${moodEmoji}</span></div></div>
                    <div class="diary-date">${formattedDate}</div>
                    <div class="diary-content">${diary.content}</div>
                    <div class="diary-actions">
                        <button class="btn btn-secondary btn-sm" onclick="viewDiary(${diary.id})"><i class="fas fa-eye"></i> ë³´ê¸°</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteDiary(${diary.id})"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                    </div>`;
                diaryListElement.appendChild(entryElement);
            });
            
            if (allDiaries.length > currentDisplayLimit) {
                loadMoreBtn.textContent = `ë”ë³´ê¸° (${Math.min(allDiaries.length - currentDisplayLimit, ENTRIES_PER_PAGE)}ê°œ)`;
                loadMoreBtn.style.display = 'block';
            } else { loadMoreBtn.style.display = 'none'; }
        }

        async function viewDiary(id) {
            const diary = await db.diaries.get(id);
            if (diary) alert(`ğŸ“ ${diary.title} ${moodMap[diary.mood] || ''}\n\nğŸ“… ${formatDate(diary.date)}\n\n${diary.content}`);
        }

        async function updateStats() {
            const allDiaries = await db.diaries.toArray();
            const now = new Date();
            const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const thisYear = now.getFullYear();
            const thisMonthDiaries = allDiaries.filter(d => d.date.startsWith(thisMonth));
            const thisYearDiaries = allDiaries.filter(d => d.date.startsWith(String(thisYear)));

            document.getElementById('thisMonthCount').textContent = thisMonthDiaries.length;
            document.getElementById('thisYearCount').textContent = thisYearDiaries.length;
            document.getElementById('totalCount').textContent = allDiaries.length;

            const totalMonths = allDiaries.length > 0 ? Math.max(1, (new Date().getFullYear() - new Date(allDiaries[allDiaries.length - 1].date).getFullYear()) * 12 + (new Date().getMonth() - new Date(allDiaries[allDiaries.length - 1].date).getMonth()) + 1) : 1;
            document.getElementById('avgPerMonth').textContent = allDiaries.length > 0 ? Math.round(allDiaries.length / totalMonths) : 0;

            const moodCounts = {};
            Object.keys(moodMap).forEach(mood => moodCounts[mood] = 0);
            allDiaries.forEach(d => { if (moodCounts[d.mood] !== undefined) moodCounts[d.mood]++; });

            const moodStatsEl = document.getElementById('moodStats');
            moodStatsEl.innerHTML = '';
            Object.entries(moodMap).forEach(([mood, emoji]) => {
                moodStatsEl.innerHTML += `<div class="mood-item"><div class="emoji">${emoji}</div><div class="count">${mood}: ${moodCounts[mood]}</div></div>`;
            });

            const monthlyData = {};
            for (let i = 1; i <= 12; i++) {
                const month = `${thisYear}-${String(i).padStart(2, '0')}`;
                monthlyData[i] = allDiaries.filter(d => d.date.startsWith(month)).length;
            }
            const monthlyStatsEl = document.getElementById('monthlyStats');
            monthlyStatsEl.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                monthlyStatsEl.innerHTML += `<div class="monthly-item"><span>${i}ì›”</span><span>${monthlyData[i]}ê°œ</span></div>`;
            }
        }

        // Goal Management - localStorage ë™ê¸°í™” ì¶”ê°€!
        async function loadGoal() {
            try {
                const goal = await db.goals.get(1);
                const displayArea = document.getElementById('goalDisplayArea');
                const editArea = document.getElementById('goalEditArea');
                const displayText = document.getElementById('goalDisplayText');
                const cancelBtn = document.getElementById('cancelGoalBtn');
                
                if (goal && goal.memo && goal.memo.trim() !== '') {
                    displayText.textContent = goal.memo;
                    displayArea.style.display = 'block';
                    editArea.style.display = 'none';
                    // localStorageì—ë„ ì €ì¥ (index.htmlì—ì„œ ì½ì„ ìˆ˜ ìˆë„ë¡)
                    localStorage.setItem('diaryGoalFirstLine', getFirstLine(goal.memo));
                } else {
                    displayArea.style.display = 'none';
                    editArea.style.display = 'block';
                    cancelBtn.style.display = 'none';
                    document.getElementById('goalMemoInput').value = '';
                    localStorage.removeItem('diaryGoalFirstLine');
                }
            } catch (error) { console.error(error); }
        }

        // ì²« ì¤„ë§Œ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜
        function getFirstLine(text) {
            if (!text) return '';
            const firstLine = text.split('\n')[0].trim();
            // ë„ˆë¬´ ê¸¸ë©´ ìë¥´ê¸° (ìµœëŒ€ 30ì)
            if (firstLine.length > 30) return firstLine.substring(0, 30) + '...';
            return firstLine;
        }

        async function saveGoal() {
            const memo = document.getElementById('goalMemoInput').value.trim();
            if (!memo) { alert('ë‹¤ì§ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            try {
                await db.goals.put({ id: 1, memo: memo });
                // localStorageì—ë„ ì €ì¥
                localStorage.setItem('diaryGoalFirstLine', getFirstLine(memo));
                // ë¶€ëª¨ ì°½ì— ì•Œë¦¼ (index.html ê°±ì‹ ìš©)
                if (window.parent !== window) window.parent.postMessage({ type: 'goalUpdate' }, '*');
                alert('ë‹¤ì§ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’ª');
                loadGoal();
            } catch (error) { alert('ì €ì¥ ì˜¤ë¥˜: ' + error); }
        }

        function editGoal() {
            const displayArea = document.getElementById('goalDisplayArea');
            const editArea = document.getElementById('goalEditArea');
            const displayText = document.getElementById('goalDisplayText');
            const cancelBtn = document.getElementById('cancelGoalBtn');
            document.getElementById('goalMemoInput').value = displayText.textContent;
            displayArea.style.display = 'none';
            editArea.style.display = 'block';
            cancelBtn.style.display = 'inline-flex';
        }

        function cancelEditGoal() { loadGoal(); }

        async function deleteGoal() {
            if (confirm('ë‹¤ì§ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await db.goals.delete(1);
                    localStorage.removeItem('diaryGoalFirstLine');
                    if (window.parent !== window) window.parent.postMessage({ type: 'goalUpdate' }, '*');
                    alert('ë‹¤ì§ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadGoal();
                } catch (error) { alert('ì‚­ì œ ì˜¤ë¥˜: ' + error); }
            }
        }

        async function globalReset() {
            if (confirm('âš ï¸ ëª¨ë“  ì¼ê¸°ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                if (confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                    try {
                        await db.diaries.clear();
                        await db.goals.clear();
                        localStorage.removeItem('diaryGoalFirstLine');
                        if (window.parent !== window) window.parent.postMessage({ type: 'goalUpdate' }, '*');
                        alert('ëª¨ë“  ì¼ê¸°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        showPage(1);
                        renderDiaryList();
                    } catch (error) { alert('ì´ˆê¸°í™” ì˜¤ë¥˜: ' + error); }
                }
            }
        }

        async function displayDataAsJson() {
            try {
                const allDiaries = await db.diaries.toArray();
                const allGoals = await db.goals.toArray();
                const backupData = { diaries: allDiaries, goals: allGoals, timestamp: new Date().toISOString(), version: '1.0' };
                if (allDiaries.length === 0 && allGoals.length === 0) { alert('ë°±ì—…í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
                const jsonString = JSON.stringify(backupData, null, 2);
                const win = window.open("", "_blank", "width=600,height=600");
                win.document.write('<h2>ë°±ì—… ë°ì´í„°</h2><p style="color: #666;">ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•˜ì—¬ ë©”ëª¨ì¥ì— ì €ì¥í•˜ì„¸ìš”.</p><textarea style="width: 100%; height: 80%; font-size: 12px;">' + jsonString + '</textarea>');
                win.document.close();
            } catch (error) { alert('ë°±ì—… ì˜¤ë¥˜: ' + error.message); }
        }

        function importDataFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm('ë³µì› ì‹œ ê¸°ì¡´ ë°ì´í„°ê°€ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { event.target.value = ''; return; }
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const dataToImport = JSON.parse(e.target.result);
                    if (!dataToImport.diaries || !Array.isArray(dataToImport.diaries)) { alert("ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤."); return; }
                    await db.diaries.bulkPut(dataToImport.diaries);
                    if (dataToImport.goals && dataToImport.goals.length > 0) {
                        await db.goals.clear();
                        await db.goals.put(dataToImport.goals[0]);
                        // localStorageë„ ì—…ë°ì´íŠ¸
                        localStorage.setItem('diaryGoalFirstLine', getFirstLine(dataToImport.goals[0].memo));
                    }
                    if (window.parent !== window) window.parent.postMessage({ type: 'goalUpdate' }, '*');
                    alert(`ë³µì› ì™„ë£Œ! ì¼ê¸° ${dataToImport.diaries.length}ê°œê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    renderDiaryList();
                    showPage(1);
                } catch (error) { alert("ë³µì› ì‹¤íŒ¨: " + error.message); }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function initializeApp() {
            document.getElementById('saveDiaryBtn').addEventListener('click', saveDiary);
            document.getElementById('searchBtn').addEventListener('click', () => {
                const query = document.getElementById('searchQuery').value;
                currentDisplayLimit = ENTRIES_PER_PAGE;
                renderDiaryList(query);
            });
            document.getElementById('listBtn').addEventListener('click', () => {
                document.getElementById('searchQuery').value = '';
                currentDisplayLimit = ENTRIES_PER_PAGE;
                isSearching = false;
                renderDiaryList();
            });
            document.getElementById('loadMoreBtn').addEventListener('click', () => {
                currentDisplayLimit += ENTRIES_PER_PAGE;
                renderDiaryList(isSearching ? document.getElementById('searchQuery').value : null);
            });
            document.getElementById('prevPageBtn').addEventListener('click', () => showPage(currentPage - 1));
            document.getElementById('nextPageBtn').addEventListener('click', () => showPage(currentPage + 1));
            document.getElementById('saveGoalBtn').addEventListener('click', saveGoal);
            document.getElementById('editGoalBtn').addEventListener('click', editGoal);
            document.getElementById('deleteGoalBtn').addEventListener('click', deleteGoal);
            document.getElementById('cancelGoalBtn').addEventListener('click', cancelEditGoal);
            document.getElementById('globalResetBtn').addEventListener('click', globalReset);
            
            renderDiaryList();
            showPage(1);
            // ì•± ë¡œë“œ ì‹œ localStorage ë™ê¸°í™”
            loadGoal();
        }

        window.onload = initializeApp;
        window.viewDiary = viewDiary;
        window.deleteDiary = deleteDiary;
        window.displayDataAsJson = displayDataAsJson;
        window.importDataFromJson = importDataFromJson;

        // ë°±ì—… ì„¹ì…˜ ì ‘ê¸°/í¼ì¹˜ê¸°
        function toggleBackupSection() {
            const section = document.getElementById('backupSection');
            const icon = document.getElementById('backupToggleIcon');
            const text = document.getElementById('backupToggleText');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                text.textContent = 'ë°±ì—…/ì´ˆê¸°í™” ì„¹ì…˜ ì ‘ê¸°';
            } else {
                section.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
                text.textContent = 'ë°±ì—…/ì´ˆê¸°í™” ì„¹ì…˜ í¼ì¹˜ê¸°';
            }
        }
        window.toggleBackupSection = toggleBackupSection;

        // ì´ì „ ë…„ë„ ë³´ê¸° í† ê¸€
        function togglePastYears() {
            const section = document.getElementById('pastYearsSection');
            const text = document.getElementById('pastYearsText');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                text.textContent = 'ì´ì „ ë…„ë„ ì ‘ê¸°';
                loadPastYears();
            } else {
                section.style.display = 'none';
                text.textContent = 'ì´ì „ ë…„ë„ ë³´ê¸°';
            }
        }
        window.togglePastYears = togglePastYears;

        // ì´ì „ ë…„ë„ ë°ì´í„° ë¡œë“œ (ë…„ë„ë³„ ì ‘ê¸°/í¼ì¹˜ê¸° + ì¼ê¸° ëª©ë¡)
        async function loadPastYears() {
            const allDiaries = await db.diaries.toArray();
            const currentYear = new Date().getFullYear();
            
            // ë…„ë„ë³„ ë¶„ë¥˜
            const yearlyData = {};
            allDiaries.forEach(diary => {
                const year = parseInt(diary.date.substring(0, 4));
                if (year < currentYear) {
                    if (!yearlyData[year]) yearlyData[year] = [];
                    yearlyData[year].push(diary);
                }
            });
            
            const pastYears = Object.keys(yearlyData).map(y => parseInt(y)).sort((a, b) => b - a);
            const container = document.getElementById('pastYearsSection');
            
            if (pastYears.length === 0) {
                container.innerHTML = '<div class="card"><div class="empty-state"><i class="fas fa-folder-open"></i><p>ì´ì „ ë…„ë„ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</p></div></div>';
                return;
            }
            
            let html = '';
            pastYears.forEach(year => {
                const diaries = yearlyData[year].sort((a, b) => new Date(b.date) - new Date(a.date));
                html += `
                    <div class="card" style="margin-bottom: 12px;">
                        <button class="btn btn-secondary" onclick="toggleYearDiaries(${year})" style="width: 100%; justify-content: space-between; background: var(--bg-primary);">
                            <span><i class="fas fa-folder"></i> ${year}ë…„ (${diaries.length}ê°œ)</span>
                            <i class="fas fa-chevron-down" id="yearIcon${year}"></i>
                        </button>
                        <div id="yearDiaries${year}" style="display: none; margin-top: 12px;">
                `;
                
                diaries.forEach(diary => {
                    const moodEmoji = diary.mood === 'great' ? 'ğŸ˜Š' : diary.mood === 'good' ? 'ğŸ™‚' : diary.mood === 'okay' ? 'ğŸ˜' : diary.mood === 'bad' ? 'ğŸ˜¢' : 'ğŸ˜¤';
                    const preview = diary.content.substring(0, 50) + (diary.content.length > 50 ? '...' : '');
                    html += `
                        <div class="diary-item" onclick="viewDiary(${diary.id})" style="cursor: pointer; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 600;">${diary.date}</span>
                                <span>${moodEmoji}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px;">${diary.title || 'ì œëª© ì—†ìŒ'}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">${preview}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
        }

        // ë…„ë„ë³„ ì¼ê¸° ëª©ë¡ í† ê¸€
        function toggleYearDiaries(year) {
            const section = document.getElementById('yearDiaries' + year);
            const icon = document.getElementById('yearIcon' + year);
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                section.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }
        window.toggleYearDiaries = toggleYearDiaries;

        // ëª¨ë°”ì¼ ë°±ì—… (ê³µìœ í•˜ê¸°)
        async function mobileBackup() {
            const diaries = await db.diaries.toArray();
            const goals = await db.goals.toArray();
            
            if (diaries.length === 0 && goals.length === 0) {
                alert('ë°±ì—…í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const data = JSON.stringify({ diaries, goals }, null, 2);
            const today = new Date().toISOString().slice(0, 10);
            const fileName = `ì¼ê¸°_ë°±ì—…_${today}.json`;
            
            // Web Share API ì§€ì› í™•ì¸
            if (navigator.share && navigator.canShare) {
                const file = new File([data], fileName, { type: 'application/json' });
                
                if (navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'ì¼ê¸° ë°±ì—…',
                            text: 'ì¼ê¸° ë°±ì—… íŒŒì¼ì…ë‹ˆë‹¤.'
                        });
                        return;
                    } catch (err) {
                        if (err.name !== 'AbortError') {
                            console.log('íŒŒì¼ ê³µìœ  ì‹¤íŒ¨, í…ìŠ¤íŠ¸ ê³µìœ  ì‹œë„');
                        } else {
                            return; // ì‚¬ìš©ìê°€ ì·¨ì†Œí•¨
                        }
                    }
                }
                
                // íŒŒì¼ ê³µìœ  ì•ˆ ë˜ë©´ í…ìŠ¤íŠ¸ë¡œ ê³µìœ 
                try {
                    await navigator.share({
                        title: 'ì¼ê¸° ë°±ì—…',
                        text: data
                    });
                    return;
                } catch (err) {
                    if (err.name === 'AbortError') return;
                }
            }
            
            // Share API ì§€ì› ì•ˆ í•˜ë©´ í´ë¦½ë³´ë“œ ë³µì‚¬
            try {
                await navigator.clipboard.writeText(data);
                alert('ë°±ì—… ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì¹´ì¹´ì˜¤í†¡ "ë‚˜ì—ê²Œ ë³´ë‚´ê¸°" ë˜ëŠ” ë©”ëª¨ì•±ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.');
            } catch (err) {
                // í´ë¦½ë³´ë“œë„ ì•ˆ ë˜ë©´ ê¸°ì¡´ ë°©ì‹
                displayDataAsJson();
            }
        }
        window.mobileBackup = mobileBackup;
    </script>
</body>
</html>
