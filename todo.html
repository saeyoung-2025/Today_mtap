<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•  ì¼ - Today App</title>
    <link rel="icon" type="image/png" href="icon-192.png">
    <script src="https://unpkg.com/dexie@3.2.3/dist/dexie.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #FAFAFA;
            --bg-secondary: #FFFFFF;
            --bg-card: #FFFFFF;
            --text-primary: #1A1A1A;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --border-color: #E5E7EB;
            --accent: #3B82F6;
            --accent-light: #EFF6FF;
            --success: #10B981;
            --success-light: #D1FAE5;
            --danger: #EF4444;
            --danger-light: #FEE2E2;
            --warning: #F59E0B;
            --warning-light: #FEF3C7;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.06);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: all 0.2s ease;
        }

        body.theme-gray {
            --bg-primary: #F3F4F6;
            --bg-secondary: #E5E7EB;
            --bg-card: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #4B5563;
            --text-muted: #9CA3AF;
            --border-color: #D1D5DB;
            --accent: #6366F1;
            --accent-light: #EEF2FF;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 80px;
            transition: var(--transition);
        }

        .container { max-width: 100%; }

        /* Header */
        .page-header { text-align: center; margin-bottom: 20px; }
        .page-header h1 { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }
        .page-header h1 i { color: var(--accent); margin-right: 8px; }

        /* Navigation */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
        }

        .nav-btn {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .nav-btn:hover:not(:disabled) { background: var(--accent); color: white; border-color: var(--accent); }
        .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .page-indicator { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); }

        /* Page Content */
        .page-content { display: none; }
        .page-content.active { display: block; }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title i { color: var(--accent); }

        /* Date Card */
        .date-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
            margin-bottom: 16px;
        }

        .date-card .date { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); }
        .date-card .time { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }

        /* Add Todo */
        .add-todo-group { display: flex; gap: 10px; }

        .add-todo-group input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.9rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .add-todo-group input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-card);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-secondary); }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-danger { background: var(--danger); color: white; }

        /* Score Card */
        .score-card { text-align: center; }

        .score-display { margin-bottom: 12px; }
        .score-display .label { font-size: 0.8rem; color: var(--text-muted); }
        .score-display .value { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); }

        .grade-display {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 1rem;
        }

        .grade-s { background: linear-gradient(135deg, #ff6b00, #ff9500); color: white; }
        .grade-a { background: linear-gradient(135deg, #10B981, #34D399); color: white; }
        .grade-b { background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; }
        .grade-c { background: linear-gradient(135deg, #F59E0B, #FBBF24); color: white; }
        .grade-d { background: linear-gradient(135deg, #F97316, #FB923C); color: white; }
        .grade-f { background: linear-gradient(135deg, #EF4444, #F87171); color: white; }

        .motivation-text { font-size: 0.8rem; color: var(--text-muted); margin-top: 12px; }

        /* Todo List */
        .todo-list { min-height: 80px; }

        .empty-state {
            text-align: center;
            color: var(--text-muted);
            padding: 30px;
            font-size: 0.875rem;
        }

        .empty-state i { font-size: 2rem; margin-bottom: 12px; opacity: 0.5; }

        .todo-item {
            display: flex;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid var(--border-color);
            gap: 12px;
        }

        .todo-item:last-child { border-bottom: none; }

        .todo-checkbox {
            appearance: none;
            width: 22px;
            height: 22px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            transition: var(--transition);
        }

        .todo-checkbox:checked { background: var(--success); border-color: var(--success); }

        .todo-checkbox:checked::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
            font-weight: bold;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .todo-content { flex: 1; display: flex; justify-content: space-between; align-items: center; }

        .todo-text { font-size: 0.9rem; color: var(--text-primary); transition: var(--transition); }

        .todo-item.done .todo-text { text-decoration: line-through; color: var(--text-muted); }

        .todo-points {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent);
            background: var(--accent-light);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
        }

        .todo-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .todo-delete:hover { background: var(--danger-light); color: var(--danger); }

        /* Save Button */
        .save-section { text-align: center; margin-top: 16px; }

        .btn-save {
            padding: 14px 30px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-save:hover { opacity: 0.9; }

        /* Info Box */
        .info-box {
            background: var(--warning-light);
            border: 1px solid var(--warning);
            border-radius: var(--radius-md);
            padding: 12px 16px;
            font-size: 0.8rem;
            color: #92400E;
            text-align: center;
            margin-top: 16px;
        }

        /* Table Styles */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .stats-table th, .stats-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .stats-table th {
            background: var(--accent);
            color: white;
            font-weight: 600;
        }

        .stats-table th:first-child { border-radius: var(--radius-sm) 0 0 0; }
        .stats-table th:last-child { border-radius: 0 var(--radius-sm) 0 0; }

        .stats-table tr:nth-child(even) { background: var(--bg-primary); }
        .stats-table tr:hover { background: var(--accent-light); }

        .stats-table .no-data { opacity: 0.4; }

        .mood-emoji { font-size: 1.25rem; }

        /* Celebration Animation for 100 score */
        @keyframes celebrate {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.3) rotate(10deg); }
            50% { transform: scale(1) rotate(-10deg); }
            75% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .celebration-emoji {
            display: inline-block;
            animation: celebrate 1s ease-in-out infinite;
        }

        /* Summary Cards */
        .summary-card {
            background: var(--accent-light);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
            margin-top: 16px;
        }

        .summary-card.success { background: var(--success-light); }
        .summary-card.warning { background: var(--warning-light); }

        .summary-card .label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 4px; }
        .summary-card .value { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }

        /* Goal Section */
        .goal-section { margin-bottom: 20px; }

        .goal-textarea, .diary-textarea {
            width: 100%;
            min-height: 120px;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.9rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            resize: vertical;
            transition: var(--transition);
        }

        .goal-textarea:focus, .diary-textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-card);
        }

        .goal-textarea:read-only, .diary-textarea:read-only {
            background: var(--bg-primary);
            cursor: default;
        }

        .goal-textarea { background: var(--success-light); border-color: var(--success); }
        .diary-textarea { background: var(--warning-light); border-color: var(--warning); }

        .goal-textarea:read-only { background: #d1fae5; }
        .diary-textarea:read-only { background: #fef3c7; }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .form-label i { color: var(--accent); margin-right: 6px; }

        .status-box {
            text-align: center;
            padding: 10px;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            font-weight: 600;
            margin: 12px 0;
        }

        .status-box.saved { background: var(--success-light); color: #065F46; }
        .status-box.editing { background: var(--warning-light); color: #92400E; }

        .button-group { display: flex; justify-content: center; gap: 12px; margin-top: 16px; }

        /* Tips Section */
        .tips-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 16px;
        }

        .tips-card h3 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tips-card ul { list-style: none; }

        .tips-card li {
            padding: 8px 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
            border-bottom: 1px solid var(--border-color);
        }

        .tips-card li:last-child { border-bottom: none; }

        .tips-card li strong { color: var(--text-primary); }

        .quote-author {
            text-align: right;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 8px;
        }

        /* Reset Section */
        .reset-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); }

        .btn-reset {
            width: 100%;
            padding: 14px;
            background: var(--bg-card);
            border: 1px solid var(--danger);
            color: var(--danger);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-reset:hover { background: var(--danger-light); }

        /* Bank Message */
        .bank-message {
            background: linear-gradient(135deg, var(--success-light), #a7f3d0);
            border-radius: var(--radius-md);
            padding: 16px;
            text-align: center;
            font-weight: 600;
            color: #065F46;
            margin-top: 16px;
        }

        /* Reminder Styles */
        #page7 {
            background-image: url('./reminder-bg.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: 20px;
            border-radius: var(--radius-lg);
            min-height: 70vh;
            position: relative;
        }

        #page7 .card {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(5px);
            position: relative;
            z-index: 2;
        }

        .bg-click-area {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
            cursor: pointer;
        }

        .bg-hint {
            text-align: center;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.95);
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            margin-top: 12px;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .bg-hint span {
            cursor: pointer;
        }

        .bg-change-btn {
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .bg-change-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Image Viewer */
        .image-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #D4A574 0%, #C4956A 25%, #A67C52 50%, #8B6914 75%, #DAA520 100%);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .image-viewer.active {
            display: flex;
        }

        .image-viewer img {
            max-width: 95%;
            max-height: 90%;
            object-fit: contain;
            border-radius: var(--radius-md);
        }

        .image-viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .image-viewer-close:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .reminder-form .form-group { margin-bottom: 12px; }

        /* Page Toggle Section */
        .page-toggle-section {
            margin-top: 20px;
            text-align: center;
        }

        .page-toggle-btn {
            width: 100%;
            padding: 14px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .page-toggle-btn:hover {
            background: var(--accent-light);
            border-color: var(--accent);
            color: var(--accent);
        }

        .page-toggle-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .page-toggle-btn i {
            transition: transform 0.3s ease;
        }

        .page-toggle-btn.active i {
            transform: rotate(180deg);
        }
        
        .reminder-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 0.9rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: var(--transition);
        }

        .reminder-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-card);
        }

        .reminder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .reminder-item:hover { border-color: var(--accent); }

        .reminder-item.today {
            background: var(--warning-light);
            border-color: var(--warning);
        }

        .reminder-item.overdue {
            background: var(--danger-light);
            border-color: var(--danger);
        }

        .reminder-item.upcoming {
            background: var(--success-light);
            border-color: var(--success);
        }

        .reminder-info { flex: 1; }

        .reminder-memo {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .reminder-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .reminder-dday {
            font-size: 0.8rem;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            margin-right: 10px;
        }

        .dday-today {
            background: var(--warning);
            color: white;
        }

        .dday-overdue {
            background: var(--danger);
            color: white;
        }

        .dday-upcoming {
            background: var(--success);
            color: white;
        }

        .reminder-delete {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .reminder-delete:hover {
            background: var(--danger-light);
            color: var(--danger);
        }

        /* Reminder Popup */
        .reminder-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .reminder-popup.active { display: flex; }

        .reminder-popup-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 24px;
            width: 90%;
            max-width: 360px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-md);
        }

        .reminder-popup-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
            text-align: center;
            margin-bottom: 16px;
        }

        .reminder-popup-item {
            padding: 12px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
        }

        .reminder-popup-item.today { background: var(--warning-light); }
        .reminder-popup-item.overdue { background: var(--danger-light); }

        .reminder-popup-item .memo {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .reminder-popup-item .status {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-check-circle"></i>í•  ì¼</h1>
        </div>

        <!-- Navigation -->
        <div class="nav-bar" id="navBar" style="display: none;">
            <button class="nav-btn" id="prevBtn" onclick="changePage(-1)"><i class="fas fa-chevron-left"></i></button>
            <span class="page-indicator">í˜ì´ì§€ <span id="currentPageNum">1</span> / 7</span>
            <button class="nav-btn" id="nextBtn" onclick="changePage(1)"><i class="fas fa-chevron-right"></i></button>
        </div>

        <!-- Page 1: Daily Checklist -->
        <div class="page-content active" id="page1">
            <div class="date-card">
                <div class="date" id="currentDate"></div>
                <div class="time" id="currentTime"></div>
            </div>

            <div class="card">
                <div class="add-todo-group">
                    <input type="text" id="newTodo" placeholder="ìƒˆë¡œìš´ í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”...">
                    <button class="btn btn-primary" onclick="addTodo()"><i class="fas fa-plus"></i> ì¶”ê°€</button>
                </div>
            </div>

            <div class="card score-card">
                <div class="score-display">
                    <span class="label">ì˜¤ëŠ˜ì˜ ì ìˆ˜</span>
                    <div class="value"><span id="currentScore">0</span> / <span id="maxScore">0</span> P</div>
                </div>
                <div class="grade-display grade-f" id="gradeDisplay">
                    <i class="fas fa-trophy"></i>
                    <span>Grade: <span id="gradeText">F</span></span>
                </div>
                <p class="motivation-text" id="motivationText">ì˜¤ëŠ˜ì˜ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê³  ì ìˆ˜ë¥¼ íšë“í•˜ì„¸ìš”!</p>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-list-check"></i> í•  ì¼ ëª©ë¡</div>
                <div class="todo-list" id="todoList">
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>

            <div class="save-section">
                <button class="btn-save" onclick="saveToStats()"><i class="fas fa-save"></i> ì˜¤ëŠ˜ ì ìˆ˜ ì €ì¥</button>
            </div>

            <div class="info-box">
                <i class="fas fa-info-circle"></i> ë§¤ì¼ ìì •ì— ì²´í¬ë°•ìŠ¤ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤
            </div>

            <!-- í˜ì´ì§€ ì ‘ê¸°/í¼ì¹˜ê¸° ë²„íŠ¼ -->
            <div class="page-toggle-section">
                <button class="page-toggle-btn" id="pageToggleBtn" onclick="toggleExtraPages()">
                    <i class="fas fa-chevron-down" id="toggleIcon"></i>
                    <span id="toggleText">í†µê³„ & ì„¤ì • í˜ì´ì§€ í¼ì¹˜ê¸° (2~7)</span>
                </button>
            </div>
        </div>

        <!-- Page 2: Daily Stats -->
        <div class="page-content" id="page2">
            <div class="card">
                <div class="card-title" id="page2Title"><i class="fas fa-calendar-days"></i> 26ë…„ 1ì›”ì˜ ë‹¬ì„± ì„±ê³¼í‘œ</div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>ì¼ì</th>
                            <th>ì ìˆ˜</th>
                            <th>ë“±ê¸‰</th>
                            <th>ë‹¬ì„±ë¥ </th>
                            <th>ê¸°ë¶„</th>
                        </tr>
                    </thead>
                    <tbody id="dailyStatsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Page 3: Monthly Stats -->
        <div class="page-content" id="page3">
            <div class="card">
                <div class="card-title"><i class="fas fa-chart-bar"></i> ì›”ë³„ ì„±ê³¼ í†µê³„</div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>ì›”</th>
                            <th>í‰ê·  ì ìˆ˜</th>
                            <th>ë“±ê¸‰</th>
                            <th>ì‘ì› ë©”ì‹œì§€</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyStatsBody"></tbody>
                </table>
            </div>
            <div class="bank-message">
                <i class="fas fa-credit-card"></i> ë‚˜ì˜ ì‹ ìš©ë„ ì ìˆ˜, ê¾¸ì¤€íˆ ìŒ“ì•„ê°€ìš” âœ¨
            </div>
        </div>

        <!-- Page 4: Yearly Stats -->
        <div class="page-content" id="page4">
            <div class="card">
                <div class="card-title"><i class="fas fa-chart-line"></i> ì—°ë„ë³„ ì„±ê³¼ íˆìŠ¤í† ë¦¬</div>
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>ì—°ë„</th>
                            <th>í‰ê·  ì ìˆ˜</th>
                            <th>ìµœê³  ë‹¬ì„±ë¥ </th>
                            <th>ë“±ê¸‰</th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="yearlyStatsBody"></tbody>
                </table>
            </div>
            <div class="summary-card">
                <div class="label"><i class="fas fa-trophy"></i> ì´ í‰ê·  ì ìˆ˜</div>
                <div class="value" id="overallAvgScore">ë°ì´í„° ìˆ˜ì§‘ì¤‘</div>
            </div>
        </div>

        <!-- Page 5: Goals & Diary -->
        <div class="page-content" id="page5">
            <div class="card">
                <div class="card-title"><i class="fas fa-bullseye"></i> ë‚˜ì˜ ëª©í‘œ & ì„±ì°° ì¼ê¸°</div>

                <div class="goal-section">
                    <label class="form-label"><i class="fas fa-lightbulb"></i> ì˜¬í•´ì˜ ëª©í‘œì™€ í¬ë¶€</label>
                    <textarea class="goal-textarea" id="goalBox" placeholder="ì´ê³³ì— 1ë…„ê°„ì˜ ì„±ê³¼ ë‹¬ì„±ì„ ìœ„í•œ ëª©í‘œì™€ í¬ë¶€ë¥¼ ê¸°ë¡í•´ë³´ì„¸ìš”..."></textarea>
                </div>

                <div class="goal-section">
                    <label class="form-label"><i class="fas fa-pen-fancy"></i> ì„±ì°°ê³¼ ë‹¬ì„± ê¸°ë¡</label>
                    <textarea class="diary-textarea" id="diaryBox" placeholder="ëª©í‘œ ë‹¬ì„± ê³¼ì •ì—ì„œì˜ ì„±ì°°, ë°˜ì„±, ì„±ì·¨ê° ë“±ì„ ììœ ë¡­ê²Œ ê¸°ë¡í•´ë³´ì„¸ìš”..."></textarea>
                </div>

                <div class="status-box" id="savedStatus"></div>

                <div class="button-group">
                    <button class="btn btn-secondary" id="clearBtn" onclick="clearInputs()"><i class="fas fa-eraser"></i> ì…ë ¥ ì§€ìš°ê¸°</button>
                    <button class="btn btn-primary" id="saveEditBtn" onclick="handleSaveEdit()"><i class="fas fa-save"></i> ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </div>

        <!-- Page 6: Tips & Reset -->
        <div class="page-content" id="page6">
            <div class="card">
                <div class="card-title"><i class="fas fa-lightbulb"></i> ì„±ê³µê³¼ ì‹œê°„ê´€ë¦¬</div>

                <div class="tips-card">
                    <h3><i class="fas fa-star"></i> ì„±ê³µ íŒ</h3>
                    <ul>
                        <li><strong>íšŒë³µë ¥ì˜ í˜:</strong> í›Œë¥­í•œ ì¼ì„ í•˜ëŠ” ê²ƒì€ ë§¤ì¼ì˜ ê¸°ì¨ê³¼ í–‰ë³µì— ê´€í•œ ê²ƒì´ ì•„ë‹™ë‹ˆë‹¤. ìì‹ ì´ í•˜ëŠ” ì¼ì„ ì‚¬ë‘í•˜ê³  íšŒë³µë ¥ì„ ê°–ëŠ” ê²ƒì…ë‹ˆë‹¤.</li>
                        <li><strong>ë„ì „ì„ í†µí•œ ì„±ì¥:</strong> ë„ˆë¬´ ë†’ì€ ê¸°ëŒ€ì¹˜ë¥¼ ê°€ì§„ ì‚¬ëŒë“¤ì€ ì¶©ë¶„í•œ íšŒë³µë ¥ì„ ê°–ì§€ ëª»í•©ë‹ˆë‹¤. ì„±ê³µì˜ ì—´ì‡ ëŠ” íšŒë³µë ¥ì…ë‹ˆë‹¤.</li>
                        <li><strong>ë…¸ë ¥ì˜ ê°€ì¹˜:</strong> ë‚˜ë³´ë‹¤ ë” ë˜‘ë˜‘í•œ ì‚¬ëŒì´ ìˆì„ ìˆ˜ ìˆì§€ë§Œ, ë‚˜ë³´ë‹¤ ë” ì—´ì‹¬íˆ ì¼í•˜ëŠ” ì‚¬ëŒì€ ì ˆëŒ€ ì—†ì„ ê²ƒì…ë‹ˆë‹¤.</li>
                    </ul>
                    <div class="quote-author">- ì  ìŠ¨ í™© -</div>
                </div>

                <div class="tips-card">
                    <h3><i class="fas fa-clock"></i> ì‹œê°„ê´€ë¦¬ ì›ì¹™</h3>
                    <ul>
                        <li><strong>ì‘ê²Œ ì‹œì‘í•˜ê¸°:</strong> ì£¼ì–´ì§„ ë‚ ì— ì•„ë¬´ê²ƒë„ í•  ìˆ˜ ì—†ë‹¤ë©´ 5ë¶„ë§Œì´ë¼ë„ í•˜ì„¸ìš”. ì‹œì‘ì´ ë°˜ì…ë‹ˆë‹¤.</li>
                        <li><strong>ìš°ì„ ìˆœìœ„ ì§‘ì¤‘:</strong> ê°€ì¥ ì¤‘ìš”í•œ 3ê°€ì§€ ì‘ì—…ì„ ë¨¼ì € ì™„ë£Œí•˜ì„¸ìš”. ë‚˜ë¨¸ì§€ëŠ” ê·¸ ë‹¤ìŒì…ë‹ˆë‹¤.</li>
                        <li><strong>ì‹œê°„ì„ íˆ¬ìë¡œ:</strong> ì ŠìŒì˜ ëª¨ë“  ìˆœê°„ì€ ìì‹ ì— ëŒ€í•œ ì‹œê°„ì  íˆ¬ìì…ë‹ˆë‹¤. í˜„ëª…í•˜ê²Œ ì„ íƒí•˜ì„¸ìš”.</li>
                    </ul>
                </div>

                <img src="./water-stone.jpg" alt="ë¬¼ë°©ìš¸ì´ ë°”ìœ„ë¥¼ ëš«ëŠ”ë‹¤" style="display: block; margin: 20px auto; max-width: 100%; border-radius: var(--radius-md); box-shadow: var(--shadow-md);" onerror="this.style.display='none'">

                <div class="reset-section">
                    <button class="btn-reset" onclick="resetAll()">
                        <i class="fas fa-trash-alt"></i> ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>

        <!-- Page 7: Reminder -->
        <div class="page-content" id="page7">
            <div class="bg-click-area" onclick="openImageViewer()"></div>
            <div class="card">
                <div class="card-title"><i class="fas fa-bell"></i> ë¦¬ë§ˆì¸ë” ì¶”ê°€</div>
                <div class="reminder-form">
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-calendar"></i> ë‚ ì§œ</label>
                        <input type="date" id="reminderDate" class="reminder-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-pen"></i> ë©”ëª¨</label>
                        <input type="text" id="reminderMemo" class="reminder-input" placeholder="ì˜ˆ: ì±™ê²¨ì•¼ í•  ìƒì¼, ì ê¸ˆ ë§Œê¸°ì¼...">
                    </div>
                    <button class="btn btn-primary" onclick="addReminder()" style="width: 100%; margin-top: 12px;">
                        <i class="fas fa-plus"></i> ë¦¬ë§ˆì¸ë” ì¶”ê°€
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-list"></i> ë¦¬ë§ˆì¸ë” ëª©ë¡</div>
                <div id="reminderList">
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <p>ë“±ë¡ëœ ë¦¬ë§ˆì¸ë”ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-hint">
                <span onclick="openImageViewer()"><i class="fas fa-image"></i> ë°°ê²½ì‚¬ì§„ í´ë¦­ + </span>
                <label class="bg-change-btn">
                    <i class="fas fa-camera"></i> ì‚¬ì§„ì„ íƒ ë³€ê²½ ê°€ëŠ¥
                    <input type="file" id="bgImageInput" accept="image/*" onchange="changeBgImage(event)" style="display: none;">
                </label>
            </div>
        </div>

        <!-- Image Viewer -->
        <div class="image-viewer" id="imageViewer" onclick="closeImageViewer()">
            <button class="image-viewer-close" onclick="closeImageViewer()">
                <i class="fas fa-times"></i>
            </button>
            <img src="./reminder-bg.jpg" alt="ë°°ê²½ ì‚¬ì§„">
        </div>

        <!-- Reminder Popup -->
        <div class="reminder-popup" id="reminderPopup">
            <div class="reminder-popup-content">
                <div class="reminder-popup-title"><i class="fas fa-bell"></i> ì˜¤ëŠ˜ì˜ ë¦¬ë§ˆì¸ë”</div>
                <div id="reminderPopupList"></div>
                <button class="btn btn-primary" onclick="closeReminderPopup()" style="width: 100%; margin-top: 16px;">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        // Theme handling from parent
        window.addEventListener('message', (event) => {
            if (event.data.type === 'themeChange') {
                document.body.classList.remove('theme-gray');
                if (event.data.theme === 'gray') {
                    document.body.classList.add('theme-gray');
                }
            }
        });

        const savedTheme = localStorage.getItem('today_app_theme');
        if (savedTheme === 'gray') {
            document.body.classList.add('theme-gray');
        }

        // Database
        const db = new Dexie('TodayAppTodoDB_V2');
        const DEFAULT_TODO_SCORE = 20;

        db.version(1).stores({
            todos: '++id, text, completed, date, score'
        });

        // Variables
        let currentPageNum = 1;
        let isEditMode = false;

        // Page Navigation
        function changePage(dir) {
            const newPage = currentPageNum + dir;
            if (newPage >= 1 && newPage <= 7) {
                document.getElementById(`page${currentPageNum}`).classList.remove('active');
                currentPageNum = newPage;
                document.getElementById(`page${currentPageNum}`).classList.add('active');
                document.getElementById('currentPageNum').textContent = currentPageNum;

                document.getElementById('prevBtn').disabled = currentPageNum === 1;
                document.getElementById('nextBtn').disabled = currentPageNum === 7;

                if (currentPageNum === 2) { updatePage2Title(); updateDailyStats(); }
                if (currentPageNum === 3) updateMonthlyStats();
                if (currentPageNum === 4) updateYearlyStats();
                if (currentPageNum === 5) loadSavedGoalData();
            }
        }

        // Update Page 2 Title
        function updatePage2Title() {
            const t = new Date();
            const y = t.getFullYear().toString().slice(-2);
            const m = t.getMonth() + 1;
            document.getElementById('page2Title').innerHTML = `<i class="fas fa-calendar-days"></i> ${y}ë…„ ${m}ì›”ì˜ ë‹¬ì„± ì„±ê³¼í‘œ`;
        }

        // Grade Helpers
        function getGradeInfo(score, forTable = false) {
            if (score >= 100) return { text: 'S', class: 'grade-s', emoji: forTable ? '<span class="celebration-emoji">ğŸ‰</span>' : 'ğŸ‰' };
            if (score >= 90) return { text: 'S', class: 'grade-s', emoji: 'ğŸ‰' };
            if (score >= 80) return { text: 'A', class: 'grade-a', emoji: 'ğŸ˜„' };
            if (score >= 70) return { text: 'B', class: 'grade-b', emoji: 'ğŸ˜Š' };
            if (score >= 60) return { text: 'C', class: 'grade-c', emoji: 'ğŸ™‚' };
            if (score >= 50) return { text: 'D', class: 'grade-d', emoji: 'ğŸ˜' };
            return { text: 'F', class: 'grade-f', emoji: 'ğŸ˜¢' };
        }

        function getMotivationalMessage(score) {
            if (score >= 100) return 'Perfect! ì™„ë²½í•œ í•˜ë£¨! ğŸŠ';
            if (score >= 80) return 'Excellent! í›Œë¥­í•´ìš”! ğŸ’ª';
            if (score >= 60) return 'Good job! ì˜í•˜ê³  ìˆì–´ìš”! ğŸ‘';
            if (score >= 40) return 'Keep going! ê³„ì† í™”ì´íŒ…! ğŸ”¥';
            if (score >= 20) return 'You can do it! í•  ìˆ˜ ìˆì–´ìš”! âœ¨';
            return 'ì˜¤ëŠ˜ì˜ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ê³  ì ìˆ˜ë¥¼ íšë“í•˜ì„¸ìš”!';
        }

        // DateTime
        function updateDateTime() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };

            document.getElementById('currentDate').textContent = now.toLocaleDateString('ko-KR', dateOptions);
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('ko-KR', timeOptions);
            checkDateChange();
        }

        function checkDateChange() {
            const t = new Date();
            const today = `${t.getFullYear()}-${t.getMonth()}-${t.getDate()}`;
            const lastDate = localStorage.getItem('todoLastCheckDate');

            if (lastDate && lastDate !== today) {
                resetDailyCheckboxes();
            }
            localStorage.setItem('todoLastCheckDate', today);
        }

        async function resetDailyCheckboxes() {
            try {
                const todos = await db.todos.toArray();
                const completedCount = todos.filter(t => t.completed).length;
                
                // ì²´í¬ëœ(ì™„ë£Œëœ) í•­ëª©ë§Œ ì‚­ì œ
                for (const todo of todos) {
                    if (todo.completed) {
                        await db.todos.delete(todo.id);
                    }
                }
                
                // ì‚­ì œëœ í•­ëª©ì´ ìˆìœ¼ë©´ ì•Œë¦¼
                if (completedCount > 0) {
                    alert(`ğŸ“‹ ìƒˆë¡œìš´ í•˜ë£¨ì…ë‹ˆë‹¤!\n\nì™„ë£Œëœ ${completedCount}ê°œ í•­ëª©ì´ ì •ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.\në¯¸ì™„ë£Œ í•­ëª©ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.`);
                }
                
                renderTodoList();
            } catch (e) {
                console.error(e);
            }
        }

        // Todo Functions
        async function addTodo() {
            const input = document.getElementById('newTodo');
            const text = input.value.trim();

            if (!text) {
                alert('í•  ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const count = await db.todos.count();
            if (count >= 5) {
                alert('ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nê¸°ì¡´ í•­ëª©ì„ ì‚­ì œí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                await db.todos.add({
                    text: text,
                    completed: false,
                    date: new Date().toISOString(),
                    score: DEFAULT_TODO_SCORE
                });
                input.value = '';
                renderTodoList();
            } catch (e) {
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(e);
            }
        }

        async function toggleComplete(id) {
            try {
                const todo = await db.todos.get(id);
                if (todo) {
                    await db.todos.update(id, { completed: !todo.completed });
                    renderTodoList();
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function deleteTodo(id) {
            if (confirm('ì´ í•  ì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await db.todos.delete(id);
                    renderTodoList();
                } catch (e) {
                    console.error(e);
                }
            }
        }

        async function renderTodoList() {
            let todos = [];
            try {
                const allTodos = await db.todos.orderBy('id').reverse().toArray();
                const uncompleted = allTodos.filter(t => !t.completed);
                const completed = allTodos.filter(t => t.completed);
                todos = [...uncompleted, ...completed];
            } catch (e) {
                todos = [];
            }

            const listEl = document.getElementById('todoList');
            listEl.innerHTML = '';

            let currentScore = 0;
            let maxScore = 0;

            if (todos.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <p>ë“±ë¡ëœ í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                `;
            } else {
                todos.forEach(todo => {
                    const score = todo.score || DEFAULT_TODO_SCORE;
                    maxScore += score;
                    if (todo.completed) currentScore += score;

                    const item = document.createElement('div');
                    item.className = `todo-item ${todo.completed ? 'done' : ''}`;
                    item.innerHTML = `
                        <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''} onclick="toggleComplete(${todo.id})">
                        <div class="todo-content">
                            <span class="todo-text">${todo.text}</span>
                            <span class="todo-points">${score}P</span>
                        </div>
                        <button class="todo-delete" onclick="deleteTodo(${todo.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    listEl.appendChild(item);
                });
            }

            document.getElementById('currentScore').textContent = currentScore;
            document.getElementById('maxScore').textContent = maxScore;

            const percentage = maxScore > 0 ? (currentScore / maxScore) * 100 : 0;
            const gradeInfo = getGradeInfo(percentage);

            document.getElementById('gradeText').textContent = gradeInfo.text;
            const gradeEl = document.getElementById('gradeDisplay');
            gradeEl.className = `grade-display ${gradeInfo.class}`;

            document.getElementById('motivationText').textContent = getMotivationalMessage(percentage);

            // Update localStorage for main page
            localStorage.setItem('todoCurrentScore', currentScore);
            localStorage.setItem('todoMaxScore', maxScore);

            // Notify parent
            if (window.parent !== window) {
                window.parent.postMessage({ type: 'statsUpdate' }, '*');
            }
        }

        // Save to Stats
        function saveToStats() {
            const currentScore = parseInt(document.getElementById('currentScore').textContent);
            if (currentScore === 0) {
                alert('ì €ì¥í•  ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }

            const t = new Date();
            const key = `${t.getFullYear()}-${t.getMonth()}-${t.getDate()}`;
            let data = JSON.parse(localStorage.getItem('todoStats') || '{}');

            data[key] = {
                score: currentScore,
                date: t.getDate(),
                month: t.getMonth(),
                year: t.getFullYear()
            };

            localStorage.setItem('todoStats', JSON.stringify(data));
            alert(`${currentScore}ì ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰\n\nğŸ’¡ ì²´í¬(ì™„ë£Œ)ëœ í•­ëª©ì€ ìµì¼ë¶€í„° ì´ˆê¸°í™” í›„ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.\në¯¸ì™„ë£Œ í•­ëª©ì€ ê³„ì† ìœ ì§€ë©ë‹ˆë‹¤.`);
        }

        // Daily Stats (Page 2)
        function updateDailyStats() {
            const t = new Date();
            const m = t.getMonth();
            const y = t.getFullYear();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const tbody = document.getElementById('dailyStatsBody');
            if (!tbody) return;

            tbody.innerHTML = '';
            const data = JSON.parse(localStorage.getItem('todoStats') || '{}');

            for (let i = 1; i <= daysInMonth; i++) {
                const key = `${y}-${m}-${i}`;
                const v = data[key];
                const row = document.createElement('tr');

                if (v) {
                    const grade = getGradeInfo(v.score, true);
                    row.innerHTML = `
                        <td>${i}ì¼</td>
                        <td>${v.score}ì </td>
                        <td><span class="${grade.class}" style="padding:2px 8px;border-radius:4px;color:white;font-size:0.75rem;">${grade.text}</span></td>
                        <td>${v.score}%</td>
                        <td class="mood-emoji">${grade.emoji}</td>
                    `;
                } else {
                    row.className = 'no-data';
                    row.innerHTML = `<td>${i}ì¼</td><td>-</td><td>-</td><td>-</td><td>-</td>`;
                }
                tbody.appendChild(row);
            }
        }

        // Monthly Stats (Page 3)
        function updateMonthlyStats() {
            const t = new Date();
            const y = t.getFullYear();
            const data = JSON.parse(localStorage.getItem('todoStats') || '{}');
            const tbody = document.getElementById('monthlyStatsBody');
            if (!tbody) return;

            tbody.innerHTML = '';
            const months = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];

            for (let m = 0; m < 12; m++) {
                let total = 0, count = 0;
                for (let k in data) {
                    const parts = k.split('-');
                    if (parseInt(parts[0]) === y && parseInt(parts[1]) === m) {
                        total += data[k].score;
                        count++;
                    }
                }

                const row = document.createElement('tr');
                if (count > 0) {
                    const avg = total / count;
                    const grade = getGradeInfo(avg);
                    const msg = getMotivationalMessage(avg);
                    row.innerHTML = `
                        <td>${months[m]}</td>
                        <td>${avg.toFixed(1)}</td>
                        <td><span class="${grade.class}" style="padding:2px 8px;border-radius:4px;color:white;font-size:0.75rem;">${grade.text}</span></td>
                        <td>${msg}</td>
                    `;
                } else {
                    row.className = 'no-data';
                    row.innerHTML = `<td>${months[m]}</td><td>-</td><td>-</td><td>-</td>`;
                }
                tbody.appendChild(row);
            }
        }

        // Yearly Stats (Page 4)
        function updateYearlyStats() {
            const data = JSON.parse(localStorage.getItem('todoStats') || '{}');
            const tbody = document.getElementById('yearlyStatsBody');
            if (!tbody) return;

            tbody.innerHTML = '';
            const cy = new Date().getFullYear();
            const years = [cy, cy+1, cy+2, cy+3, cy+4];
            let overallTotal = 0, overallCount = 0;

            years.forEach(y => {
                let yearTotal = 0, yearCount = 0, maxScore = 0;

                for (let k in data) {
                    if (parseInt(k.split('-')[0]) === y) {
                        const s = data[k].score;
                        yearTotal += s;
                        yearCount++;
                        if (s > maxScore) maxScore = s;
                    }
                }

                const row = document.createElement('tr');
                if (yearCount > 0) {
                    const avg = yearTotal / yearCount;
                    const grade = getGradeInfo(avg);
                    overallTotal += yearTotal;
                    overallCount += yearCount;
                    row.innerHTML = `
                        <td>${y}</td>
                        <td>${avg.toFixed(1)}ì </td>
                        <td>${maxScore}%</td>
                        <td><span class="${grade.class}" style="padding:2px 8px;border-radius:4px;color:white;font-size:0.75rem;">${grade.text}</span></td>
                        <td>ğŸ”¥ Active</td>
                    `;
                } else {
                    const status = y === cy ? 'ğŸ”¥ Active' : 'ğŸ¯ Planning';
                    row.className = y !== cy ? 'no-data' : '';
                    row.innerHTML = `<td>${y}</td><td>-</td><td>-</td><td>-</td><td>${status}</td>`;
                }
                tbody.appendChild(row);
            });

            const overallEl = document.getElementById('overallAvgScore');
            if (overallCount > 0) {
                const avg = (overallTotal / overallCount).toFixed(1);
                const grade = getGradeInfo(overallTotal / overallCount);
                overallEl.textContent = `${avg}ì  (ë“±ê¸‰: ${grade.text})`;
            } else {
                overallEl.textContent = 'ë°ì´í„° ìˆ˜ì§‘ì¤‘';
            }
        }

        // Goals & Diary (Page 5)
        function loadSavedGoalData() {
            const goal = localStorage.getItem('todoUserGoal') || '';
            const diary = localStorage.getItem('todoUserDiary') || '';

            document.getElementById('goalBox').value = goal;
            document.getElementById('diaryBox').value = diary;

            isEditMode = !!(goal || diary);
            updateEditModeUI();
        }

        function handleSaveEdit() {
            if (isEditMode) {
                isEditMode = false;
                updateEditModeUI();
            } else {
                const goal = document.getElementById('goalBox').value.trim();
                const diary = document.getElementById('diaryBox').value.trim();

                if (!goal && !diary) {
                    alert('ì €ì¥í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤!');
                    return;
                }

                localStorage.setItem('todoUserGoal', goal);
                localStorage.setItem('todoUserDiary', diary);
                isEditMode = true;
                updateEditModeUI();
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! âœ¨');
            }
        }

        function updateEditModeUI() {
            const goalBox = document.getElementById('goalBox');
            const diaryBox = document.getElementById('diaryBox');
            const saveBtn = document.getElementById('saveEditBtn');
            const clearBtn = document.getElementById('clearBtn');
            const statusBox = document.getElementById('savedStatus');

            if (isEditMode) {
                goalBox.readOnly = true;
                diaryBox.readOnly = true;
                saveBtn.innerHTML = '<i class="fas fa-edit"></i> ìˆ˜ì •í•˜ê¸°';
                // clearBtnì€ í•­ìƒ í™œì„±í™” ìƒíƒœ ìœ ì§€
                statusBox.textContent = 'âœ… ì €ì¥ë¨ - ìˆ˜ì •í•˜ë ¤ë©´ "ìˆ˜ì •í•˜ê¸°" ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”';
                statusBox.className = 'status-box saved';
            } else {
                goalBox.readOnly = false;
                diaryBox.readOnly = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> ì €ì¥í•˜ê¸°';
                const hasContent = goalBox.value.trim() || diaryBox.value.trim();
                statusBox.textContent = hasContent ? 'ğŸ“ í¸ì§‘ ì¤‘ - ë³€ê²½ì‚¬í•­ì„ ì €ì¥í•˜ì„¸ìš”' : '';
                statusBox.className = hasContent ? 'status-box editing' : 'status-box';
            }
        }

        function clearInputs() {
            // ì €ì¥ëœ ìƒíƒœë©´ ë¨¼ì € ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜
            if (isEditMode) {
                if (confirm('ì €ì¥ëœ ë‚´ìš©ì„ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    document.getElementById('goalBox').value = '';
                    document.getElementById('diaryBox').value = '';
                    localStorage.removeItem('todoUserGoal');
                    localStorage.removeItem('todoUserDiary');
                    isEditMode = false;
                    updateEditModeUI();
                    alert('ë‚´ìš©ì´ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.');
                }
            } else {
                if (confirm('ì…ë ¥ëœ ë‚´ìš©ì„ ëª¨ë‘ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    document.getElementById('goalBox').value = '';
                    document.getElementById('diaryBox').value = '';
                    localStorage.removeItem('todoUserGoal');
                    localStorage.removeItem('todoUserDiary');
                    isEditMode = false;
                    updateEditModeUI();
                    alert('ë‚´ìš©ì´ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤.');
                }
            }
        }

        // Reset All
        async function resetAll() {
            if (confirm('âš ï¸ ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní•  ì¼ ëª©ë¡, ì ìˆ˜ ê¸°ë¡, ëª©í‘œ/ì„±ì°° ì¼ê¸°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) {
                try {
                    await db.todos.clear();
                    localStorage.removeItem('todoStats');
                    localStorage.removeItem('todoUserGoal');
                    localStorage.removeItem('todoUserDiary');
                    localStorage.removeItem('todoLastCheckDate');
                    localStorage.removeItem('todoCurrentScore');
                    localStorage.removeItem('todoMaxScore');

                    if (window.parent !== window) {
                        window.parent.postMessage({ type: 'statsUpdate' }, '*');
                    }

                    alert('ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload();
                } catch (e) {
                    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
                }
            }
        }

        // Initialize
        function init() {
            document.getElementById('newTodo').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTodo();
            });

            document.getElementById('prevBtn').disabled = true;

            // ë¦¬ë§ˆì¸ë” ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì • (ì˜¤ëŠ˜)
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reminderDate').value = today;

            updateDateTime();
            setInterval(updateDateTime, 1000);
            renderTodoList();
            renderReminderList();
            
            // ì €ì¥ëœ ë°°ê²½ ì´ë¯¸ì§€ ë¡œë“œ
            loadSavedBgImage();
            
            // ì•± ì‹œì‘ ì‹œ ë¦¬ë§ˆì¸ë” ì²´í¬
            checkReminders();
        }

        // ========== ë¦¬ë§ˆì¸ë” ê¸°ëŠ¥ ==========
        
        // ë¦¬ë§ˆì¸ë” ì¶”ê°€
        function addReminder() {
            const dateInput = document.getElementById('reminderDate');
            const memoInput = document.getElementById('reminderMemo');
            
            const date = dateInput.value;
            const memo = memoInput.value.trim();
            
            if (!date) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            if (!memo) {
                alert('ë©”ëª¨ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            // localStorageì—ì„œ ë¦¬ë§ˆì¸ë” ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            let reminders = JSON.parse(localStorage.getItem('todoReminders') || '[]');
            
            // ìƒˆ ë¦¬ë§ˆì¸ë” ì¶”ê°€
            reminders.push({
                id: Date.now(),
                date: date,
                memo: memo
            });
            
            // ë‚ ì§œìˆœ ì •ë ¬
            reminders.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // ì €ì¥
            localStorage.setItem('todoReminders', JSON.stringify(reminders));
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            memoInput.value = '';
            
            // ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§
            renderReminderList();
            
            alert('ë¦¬ë§ˆì¸ë”ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ””');
        }
        
        // ë¦¬ë§ˆì¸ë” ì‚­ì œ
        function deleteReminder(id) {
            if (confirm('ì´ ë¦¬ë§ˆì¸ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                let reminders = JSON.parse(localStorage.getItem('todoReminders') || '[]');
                reminders = reminders.filter(r => r.id !== id);
                localStorage.setItem('todoReminders', JSON.stringify(reminders));
                renderReminderList();
            }
        }
        
        // D-day ê³„ì‚°
        function calculateDday(dateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const targetDate = new Date(dateStr);
            targetDate.setHours(0, 0, 0, 0);
            
            const diff = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
            
            return diff;
        }
        
        // D-day í…ìŠ¤íŠ¸ ìƒì„±
        function getDdayText(dday) {
            if (dday === 0) return 'ì˜¤ëŠ˜';
            if (dday < 0) return `D+${Math.abs(dday)}`;
            return `D-${dday}`;
        }
        
        // ë¦¬ë§ˆì¸ë” ëª©ë¡ ë Œë”ë§
        function renderReminderList() {
            const listEl = document.getElementById('reminderList');
            const reminders = JSON.parse(localStorage.getItem('todoReminders') || '[]');
            
            if (reminders.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <p>ë“±ë¡ëœ ë¦¬ë§ˆì¸ë”ê°€ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                `;
                return;
            }
            
            listEl.innerHTML = '';
            
            reminders.forEach(reminder => {
                const dday = calculateDday(reminder.date);
                const ddayText = getDdayText(dday);
                
                let itemClass = 'reminder-item';
                let ddayClass = 'reminder-dday';
                
                if (dday === 0) {
                    itemClass += ' today';
                    ddayClass += ' dday-today';
                } else if (dday < 0) {
                    itemClass += ' overdue';
                    ddayClass += ' dday-overdue';
                } else if (dday <= 7) {
                    itemClass += ' upcoming';
                    ddayClass += ' dday-upcoming';
                }
                
                const dateObj = new Date(reminder.date);
                const dateFormatted = dateObj.toLocaleDateString('ko-KR', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'short'
                });
                
                const item = document.createElement('div');
                item.className = itemClass;
                item.innerHTML = `
                    <div class="reminder-info">
                        <div class="reminder-memo">${reminder.memo}</div>
                        <div class="reminder-date">${dateFormatted}</div>
                    </div>
                    <span class="${ddayClass}">${ddayText}</span>
                    <button class="reminder-delete" onclick="deleteReminder(${reminder.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                
                listEl.appendChild(item);
            });
        }
        
        // ì•± ì‹œì‘ ì‹œ ë¦¬ë§ˆì¸ë” ì²´í¬ (ì˜¤ëŠ˜/ì§€ë‚œ ê²ƒ íŒì—…)
        function checkReminders() {
            const reminders = JSON.parse(localStorage.getItem('todoReminders') || '[]');
            const todayReminders = [];
            
            reminders.forEach(reminder => {
                const dday = calculateDday(reminder.date);
                if (dday <= 0) {
                    todayReminders.push({
                        ...reminder,
                        dday: dday
                    });
                }
            });
            
            if (todayReminders.length > 0) {
                showReminderPopup(todayReminders);
            }
        }
        
        // ë¦¬ë§ˆì¸ë” íŒì—… í‘œì‹œ
        function showReminderPopup(reminders) {
            const popupList = document.getElementById('reminderPopupList');
            popupList.innerHTML = '';
            
            reminders.forEach(reminder => {
                const itemClass = reminder.dday === 0 ? 'reminder-popup-item today' : 'reminder-popup-item overdue';
                const statusText = reminder.dday === 0 ? 'ğŸ”” ì˜¤ëŠ˜ì´ì—ìš”!' : `âš ï¸ ${Math.abs(reminder.dday)}ì¼ ì§€ë‚¬ì–´ìš”!`;
                
                const dateObj = new Date(reminder.date);
                const dateFormatted = dateObj.toLocaleDateString('ko-KR', {
                    month: 'long',
                    day: 'numeric'
                });
                
                popupList.innerHTML += `
                    <div class="${itemClass}">
                        <div class="memo">${reminder.memo}</div>
                        <div class="status">${dateFormatted} - ${statusText}</div>
                    </div>
                `;
            });
            
            document.getElementById('reminderPopup').classList.add('active');
        }
        
        // ë¦¬ë§ˆì¸ë” íŒì—… ë‹«ê¸°
        function closeReminderPopup() {
            document.getElementById('reminderPopup').classList.remove('active');
        }

        window.onload = init;
        window.toggleComplete = toggleComplete;
        window.deleteTodo = deleteTodo;
        window.deleteReminder = deleteReminder;

        // ì´ë¯¸ì§€ ë·°ì–´ ì—´ê¸°/ë‹«ê¸°
        function openImageViewer() {
            document.getElementById('imageViewer').classList.add('active');
        }

        function closeImageViewer() {
            document.getElementById('imageViewer').classList.remove('active');
        }

        // ë°°ê²½ ì´ë¯¸ì§€ ë³€ê²½
        function changeBgImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                // localStorageì— ì €ì¥
                localStorage.setItem('todoReminderBg', imageData);
                
                // ë°°ê²½ ì ìš©
                document.getElementById('page7').style.backgroundImage = `url('${imageData}')`;
                
                // ì´ë¯¸ì§€ ë·°ì–´ì—ë„ ì ìš©
                document.querySelector('#imageViewer img').src = imageData;
                
                alert('ë°°ê²½ ì‚¬ì§„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸŒ¸');
            };
            reader.readAsDataURL(file);
        }

        // ì €ì¥ëœ ë°°ê²½ ì´ë¯¸ì§€ ë¡œë“œ
        function loadSavedBgImage() {
            const savedBg = localStorage.getItem('todoReminderBg');
            if (savedBg) {
                document.getElementById('page7').style.backgroundImage = `url('${savedBg}')`;
                document.querySelector('#imageViewer img').src = savedBg;
            }
        }

        // ========== í˜ì´ì§€ ì ‘ê¸°/í¼ì¹˜ê¸° ==========
        let isExtraPagesOpen = false;

        function toggleExtraPages() {
            isExtraPagesOpen = !isExtraPagesOpen;
            
            const navBar = document.getElementById('navBar');
            const toggleBtn = document.getElementById('pageToggleBtn');
            const toggleIcon = document.getElementById('toggleIcon');
            const toggleText = document.getElementById('toggleText');
            
            if (isExtraPagesOpen) {
                navBar.style.display = 'flex';
                toggleBtn.classList.add('active');
                toggleText.textContent = 'í†µê³„ & ì„¤ì • í˜ì´ì§€ ì ‘ê¸°';
                localStorage.setItem('todoExtraPagesOpen', 'true');
            } else {
                navBar.style.display = 'none';
                toggleBtn.classList.remove('active');
                toggleText.textContent = 'í†µê³„ & ì„¤ì • í˜ì´ì§€ í¼ì¹˜ê¸° (2~7)';
                localStorage.setItem('todoExtraPagesOpen', 'false');
                
                // 1í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
                if (currentPageNum !== 1) {
                    document.getElementById(`page${currentPageNum}`).classList.remove('active');
                    currentPageNum = 1;
                    document.getElementById('page1').classList.add('active');
                    document.getElementById('currentPageNum').textContent = 1;
                }
            }
        }

        // ì €ì¥ëœ í˜ì´ì§€ í¼ì¹¨ ìƒíƒœ ë¡œë“œ
        function loadExtraPagesState() {
            const saved = localStorage.getItem('todoExtraPagesOpen');
            if (saved === 'true') {
                isExtraPagesOpen = true;
                document.getElementById('navBar').style.display = 'flex';
                document.getElementById('pageToggleBtn').classList.add('active');
                document.getElementById('toggleText').textContent = 'í†µê³„ & ì„¤ì • í˜ì´ì§€ ì ‘ê¸°';
            }
        }

        // initì—ì„œ í˜¸ì¶œ
        document.addEventListener('DOMContentLoaded', loadExtraPagesState);
    </script>
</body>
</html>
